<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å®¶ç”¨é»æ•¸ä»»å‹™æ¿ v5.5 (å®Œæ•´ä¿®å¾©ç‰ˆ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* ç¦æ­¢ç¸®æ”¾ */
    html, body { 
        touch-action: manipulation; 
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
        background: #f5f5f7; 
        overflow-x: hidden; 
        -webkit-user-select: none;
        user-select: none;
        min-height: 100%;
    }

    input {
        -webkit-user-select: text;
        user-select: text;
    }

    body { font-size: 18px; }

    .app {
      max-width: 480px;
      margin: 16px auto;
      background: white;
      border-radius: 24px;
      box-shadow: 0 0 12px rgba(0,0,0,0.12);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 88vh;
      position: relative; 
    }

    .app.boy header { background: linear-gradient(135deg,#4f8cf7,#7ab8ff); }
    .app.girl header { background: linear-gradient(135deg,#ff7eb3,#ff9a9e); }

    header {
      color: white;
      padding: 18px 18px 14px;
    }
    .header-top { display:flex; justify-content:space-between; align-items:center; }
    .kid-main { display:flex; align-items:center; gap:10px; }
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #ffdd66;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 700;
      font-size: 22px;
      color: #333;
      flex-shrink: 0;
      position: relative; /* For connection dot positioning */
    }

    /* é€£ç·šç‹€æ…‹ç‡ˆè™Ÿ */
    .connection-dot {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 14px;
        height: 14px;
        background-color: #ccc; /* Default gray */
        border: 2px solid #fff;
        border-radius: 50%;
        transition: background-color 0.3s ease, transform 0.3s ease;
        z-index: 10;
    }
    .connection-dot.online { background-color: #4caf50; box-shadow: 0 0 6px rgba(76, 175, 80, 0.6); }
    .connection-dot.offline { background-color: #f44336; }
    .connection-dot.syncing { background-color: #ff9800; animation: pulse 1s infinite; }
    
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    
    .kid-info-block { display: flex; flex-direction: column; }
    
    .name-row { display: flex; align-items: center; gap: 8px; }
    .kid-name { font-size: 22px; font-weight: 700; }
    
    .save-badge {
        font-size: 12px;
        background: rgba(255,255,255,0.25);
        padding: 2px 8px;
        border-radius: 10px;
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
        white-space: nowrap;
    }
    .save-badge.show { opacity: 1; }

    .kid-sub { font-size: 14px; opacity: 0.95; }
    
    .switch-btn {
      border: none;
      background: rgba(255,255,255,0.25);
      color: white;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
    }
    .header-bottom {
      margin-top: 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap: 8px;
    }
    
    .date-chip {
      background: rgba(255,255,255,0.25);
      padding: 6px 12px;
      border-radius: 999px;
      white-space: nowrap;
      font-size: 14px;
      cursor: pointer; 
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid rgba(255,255,255,0.1);
      align-self: center;
    }
    .date-chip:active { background: rgba(255,255,255,0.4); }
    .date-chip::after { content: "â–¾"; font-size: 12px; opacity: 0.8; }

    .points-container {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .total-points {
      font-size: 26px;
      font-weight: 800;
      display:flex;
      align-items:center;
      gap: 6px;
      white-space: nowrap;
      line-height: 1.1;
    }
    
    .weekly-points {
        font-size: 13px;
        opacity: 0.9;
        margin-top: 2px;
        font-weight: 500;
    }

    main {
      padding: 10px 16px 12px;
      flex: 1;
      overflow-y: auto;
    }
    h2 { font-size: 18px; margin: 10px 0 6px; }
    .card {
      background:#fff;
      border-radius:16px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }

    .week-wrapper {
      overflow-x:auto;
      padding-bottom: 6px;
      position: relative;
      scroll-behavior: smooth; 
    }
    .week-table {
      min-width: 640px; 
      border-radius: 16px;
      background:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,0.04);
      padding:10px;
    }
    .week-header, .task-row, .day-summary-row {
      display:flex;
      align-items:center;
      gap: 6px;
      font-size: 14px;
    }
    .week-header { font-weight:700; margin-bottom:6px; }
    
    .task-name-header, .task-name, .task-name-summary {
      flex:0 0 120px;
      min-width:120px;
      font-size:14px;
      font-weight:600;
      position: sticky;
      left: 0;
      background: #fff; 
      z-index: 10;
      box-shadow: 2px 0 5px rgba(0,0,0,0.05); 
      margin-right: -1px;
      align-self: stretch; 
      display: flex;
      align-items: center;
    }
    
    .week-list-item {
        padding: 12px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .week-list-item:last-child { border-bottom: none; }
    .week-list-item.active {
        background-color: #e3f2fd;
        color: #1565c0;
        font-weight: bold;
    }

    .day-header, .day-cell-wrapper, .day-summary-cell {
      flex:1;
      text-align:center;
      display: flex;
      flex-direction: column; 
      justify-content: center;
      align-items: center;
    }
    .date-label {
        font-size: 11px;
        color: #888;
        margin-top: 2px;
        font-weight: normal;
    }

    .custom-check {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 2px solid #ddd;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.1s ease; 
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .custom-check.checked {
      background: #4caf50;
      border-color: #4caf50;
      color: white;
    }
    .custom-check.crossed {
      background: #ffebee;
      border-color: #ffcdd2;
      color: #c62828;
    }
    /* Bonus Task Styling */
    .task-row.bonus-row .custom-check.checked {
        background: #ff9800; /* Orange/Gold for Bonus */
        border-color: #ff9800;
    }
    .bonus-separator {
        padding: 8px 0;
        text-align: center;
        font-size: 12px;
        color: #888;
        background: #fafafa;
        margin: 4px 0;
        border-radius: 4px;
        font-weight: bold;
        letter-spacing: 1px;
    }

    .task-row { margin-bottom:6px; }
    .day-summary-row {
      margin-top:4px;
      padding-top:4px;
      border-top:1px dashed #eee;
      font-size:13px;
      color:#555;
    }
    .day-summary-cell-positive { color:#2e7d32; font-weight:600; }
    .day-summary-cell-negative { color:#c62828; font-weight:600; }
    .today-col { background:#e3f2fd; border-radius:8px; }

    .history-item { display:flex; justify-content:space-between; margin-bottom:10px; font-size: 15px; }
    .history-main { max-width: 70%; }
    .history-date { font-size: 13px; color:#888; }
    .history-delta { font-weight: 600; font-size: 16px; }
    .history-delete-btn {
      margin-top: 4px;
      padding: 2px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fafafa;
      cursor: pointer;
    }
    .settings-group { margin-bottom: 16px; }
    .settings-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #eee;
      font-size: 15px;
    }
    .settings-label { font-weight: 600; }
    .settings-sub { font-size: 13px; color:#777; margin-top:2px; }
    .settings-btn {
      border-radius:999px;
      border:1px solid #ddd;
      background:#fafafa;
      padding:6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .delete-task-btn { color: #c62828; border-color: #ffcdd2; background: #ffebee; }

    .quick-row { display:flex; gap:10px; margin-top:6px; }
    .pill-btn {
      flex:1;
      border-radius:999px;
      border:none;
      padding:14px 8px; 
      font-size:16px;
      font-weight: 700;
      cursor:pointer;
    }
    .pill-plus { background:#e3f2fd; color:#1565c0; }
    .pill-minus { background:#ffebee; color:#c62828; }
    .small-label { font-size: 13px; color:#777; margin-top:6px; }
    .small-input {
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #ddd;
      margin-top:4px;
      font-size: 15px;
    }

    .tab-page { display:none; }
    .tab-page.active { display:block; }
    nav {
      display:flex;
      justify-content:space-around;
      border-top:1px solid #ddd;
      background:#fff;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item {
      flex:1;
      text-align:center;
      padding:10px 0 12px;
      font-size: 14px;
      cursor:pointer;
      color:#777;
    }
    .nav-icon { display:block; font-size: 20px; margin-bottom:2px; }
    .nav-item.active { color:#3366cc; font-weight:600; }

    #toast-msg { pointer-events: none; }

    /* New Update Banner */
    #update-banner {
        display: none;
        position: fixed;
        bottom: 70px; /* Above nav bar */
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        white-space: nowrap;
        animation: slideUp 0.5s ease;
    }
    @keyframes slideUp {
        from { transform: translate(-50%, 20px); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9990;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: white;
      width: 90%;
      max-width: 400px;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      max-height: 80vh; 
      overflow-y: auto;
    }
    .modal h3 { margin-bottom: 16px; font-size: 20px; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px; color: #555; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .btn-cancel { background: #f5f5f5; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 15px; }
    .btn-save { background: #4f8cf7; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; }
    
    .radio-group { display: flex; gap: 16px; }
    .radio-label { display: flex; align-items: center; gap: 6px; font-size: 15px; cursor: pointer; }

    input[type="number"], input[type="text"] { font-size: 16px; }

    /* ç‰¹æ•ˆå‹•ç•« */
    .coin-effect {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 80px;
      pointer-events: none;
      z-index: 10000;
      display: none;
    }
    .coin-effect.animate {
      display: block;
      animation: coinUp 0.6s ease-out forwards;
    }
    @keyframes coinUp {
      0% { transform: translate(-50%, -20%) scale(0); opacity: 0; }
      20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -200%) scale(1); opacity: 0; }
    }

    .deduct-effect {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 80px;
      pointer-events: none;
      z-index: 10000;
      display: none;
      color: #c62828;
    }
    .deduct-effect.animate {
      display: block;
      animation: dropDown 0.6s ease-in forwards;
    }
    @keyframes dropDown {
      0% { transform: translate(-50%, -100%) scale(0); opacity: 0; }
      20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, 150%) scale(0.8); opacity: 0; }
    }
    
    .empty-state { text-align: center; color: #999; padding: 20px; font-size: 14px; }
    
    /* Version info styling */
    .version-info {
        text-align: center;
        font-size: 12px;
        color: #aaa;
        padding: 10px 0 20px;
        font-family: monospace;
    }
    
    /* Family Login Modal Styles */
    .login-modal-content {
        text-align: center;
        padding-top: 10px;
    }
    .login-logo {
        font-size: 48px;
        margin-bottom: 16px;
    }
    .login-desc {
        color: #666;
        margin-bottom: 24px;
        font-size: 15px;
        line-height: 1.5;
    }
    .login-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #ddd;
        border-radius: 12px;
        font-size: 18px;
        text-align: center;
        margin-bottom: 20px;
        outline: none;
        transition: border-color 0.3s;
    }
    .login-input:focus {
        border-color: #4f8cf7;
    }
    .login-btn {
        width: 100%;
        background: #4f8cf7;
        color: white;
        border: none;
        padding: 14px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(79, 140, 247, 0.3);
    }
    .login-btn:active {
        transform: scale(0.98);
    }
    
    .family-id-tag {
        display: inline-block;
        background: #eee;
        color: #555;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 11px;
        margin-left: 4px;
    }
  </style>
</head>
<body>
  <div class="app boy">
    <header>
      <div class="header-top">
        <div class="kid-main">
          <div class="avatar">
            L
            <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤ºç‡ˆ -->
            <div id="db-status" class="connection-dot" title="é€£ç·šä¸­..."></div>
          </div>
          <div class="kid-info-block">
            <div class="name-row">
                <div class="kid-name">Leo</div>
                <div id="save-badge" class="save-badge">âœ… å·²åŒæ­¥</div>
            </div>
            <div class="kid-sub">ä»Šå¤©ä¸€èµ·åŠ æ²¹ ğŸ’ª</div>
          </div>
        </div>
        <button class="switch-btn" type="button">åˆ‡æ›å°å­© â–¾</button>
      </div>
      <div class="header-bottom">
        <div class="date-chip" id="date-chip" onclick="openWeekSelectModal()">æœ¬é€±ï¼š-- / --</div>
        <div class="points-container">
            <div class="total-points" id="total-points">
              <span>â­</span>
              <span>0 é»</span>
            </div>
            <!-- æ–°å¢ï¼šæœ¬é€±é»æ•¸ -->
            <div class="weekly-points" id="weekly-points">
                æœ¬é€±ï¼š0 é»
            </div>
        </div>
      </div>
    </header>

    <main>
      <section class="tab-page active" data-tab="today">
        <h2>ä»»å‹™è¡¨ <span id="viewing-week-label" style="font-size:14px; color:#666; font-weight:normal;">(æœ¬é€±)</span></h2>
        <div class="week-wrapper">
        <div class="week-table" id="week-table"></div>
        </div>

        <h2>å¿«é€ŸåŠ  / æ‰£é»ï¼ˆçˆ¸åª½ï¼‰</h2>
        <div class="card" id="quick-points-card">
          <div class="small-label">èª¿æ•´ä»Šå¤©çš„é»æ•¸ï¼ˆä¹Ÿæœƒå½±éŸ¿ç¸½é»æ•¸ï¼‰</div>
          <div class="quick-row">
            <button class="pill-btn pill-plus" type="button" onclick="handleQuickAdd(1)">+1 é»</button>
            <button class="pill-btn pill-minus" type="button" onclick="handleQuickAdd(-1)">-1 é»</button>
          </div>
          <div class="small-label">å‚™è¨»ï¼ˆé¸å¡«ï¼Œè¨˜éŒ„åŸå› ï¼‰</div>
          <input class="small-input" id="quick-note-input" placeholder="ä¾‹ï¼šä»Šå¤©ä¸»å‹•å¹«å¿™æ”¶ç©å…· +1 é»" />
        </div>
      </section>

      <section class="tab-page" data-tab="rewards">
        <h2>é»æ•¸å…Œæ›</h2>
        <div class="card">
          <div style="font-size:16px; margin-bottom:4px;">
            ç›®å‰å°å­©ï¼š<strong><span id="redeem-kid-name">Leo</span></strong>
          </div>
          <div style="font-size:15px;">
            å¯ç”¨ç¸½é»æ•¸ï¼š<span id="redeem-kid-points" style="font-size:22px;font-weight:800;">0</span> é»
          </div>
          <div style="font-size:13px;color:#777;margin-top:6px;">
            ï¼ˆé€™è£¡é¡¯ç¤ºçš„æ˜¯ç›®å‰é€™ä½å°å­©çš„ç¸½é»æ•¸ï¼Œå…Œæ›æ™‚æœƒå¾é€™è£¡æ‰£é™¤ï¼‰
          </div>
        </div>

        <h2>è¼¸å…¥å…Œæ›å…§å®¹</h2>
        <div class="card">
          <div class="small-label">å…Œæ›åç¨±</div>
          <input id="redeem-name-input" class="small-input" placeholder="ä¾‹ï¼šå»çœ‹ç«è»Šã€æ›ä¸€å€‹ç©å…·..." />

          <div class="small-label">æ‰£é™¤é»æ•¸</div>
          <input id="redeem-points-input" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input" placeholder="ä¾‹ï¼š20" />

          <div class="small-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</div>
          <input id="redeem-note-input" class="small-input" placeholder="ä¾‹ï¼šå‡æ—¥é™å®š" />

          <div class="quick-row" style="margin-top:10px;">
            <button id="redeem-confirm-btn" class="pill-btn pill-minus" type="button">ç¢ºèªå…Œæ›</button>
          </div>
        </div>
      </section>

      <section class="tab-page" data-tab="history">
        <h2>è¿‘æœŸé»æ•¸ç´€éŒ„ <span id="history-week-label" style="font-size:14px; color:#666; font-weight:normal;"></span></h2>
        <div class="card" id="points-history-card"></div>
      </section>

      <section class="tab-page" data-tab="settings">
        <h2>å°å­©ç®¡ç†</h2>
        <div class="card settings-group" id="settings-kid-list"></div>

        <h2>ä¸€èˆ¬ä»»å‹™ç®¡ç† <span id="settings-task-kid-label" style="font-size:14px; color:#666; font-weight:normal;"></span></h2>
        <div class="card settings-group">
          <div id="settings-task-list"></div>
          <div class="settings-item">
            <div style="width: 100%; padding-right: 10px;">
              <div class="settings-label">æ–°å¢ä¸€èˆ¬ä»»å‹™</div>
              <input id="settings-new-task-input" class="small-input" placeholder="ä¾‹ï¼šä¸»å‹•å¹«å¿™åšå®¶äº‹..." />
            </div>
            <button id="settings-new-task-btn" class="settings-btn" type="button">æ–°å¢</button>
          </div>
        </div>

        <h2>Bonus ä»»å‹™ç®¡ç† (å®Œæˆç›´æ¥+1)</h2>
        <div class="card settings-group">
          <div id="settings-bonus-task-list"></div>
          <div class="settings-item">
            <div style="width: 100%; padding-right: 10px;">
              <div class="settings-label">æ–°å¢ Bonus ä»»å‹™</div>
              <input id="settings-new-bonus-task-input" class="small-input" placeholder="ä¾‹ï¼šå½ˆé‹¼ç´ã€èƒŒå–®å­—..." />
            </div>
            <button id="settings-new-bonus-task-btn" class="settings-btn" type="button">æ–°å¢</button>
          </div>
        </div>

        <h2>æ¯æ—¥é»æ•¸è¦å‰‡ (åƒ…é©ç”¨ä¸€èˆ¬ä»»å‹™)</h2>
        <div class="card settings-group">
          <!-- Dynamic Rule List -->
          <div id="settings-rules-list"></div>

          <!-- Add Rule UI -->
          <div class="settings-item" style="align-items: flex-start;">
            <div style="flex: 1; padding-right: 10px;">
              <div class="settings-label">æ–°å¢è¦å‰‡</div>
              <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                 <span style="font-size:14px;">å®Œæˆ â‰§</span>
                 <input id="rule-threshold-input" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input" style="width:60px; text-align:center;" placeholder="3" />
                 <span style="font-size:14px;">é …</span>
              </div>
              <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                 <span style="font-size:14px;">åŠ </span>
                 <input id="rule-points-input" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input" style="width:60px; text-align:center;" placeholder="2" />
                 <span style="font-size:14px;">é»</span>
              </div>
            </div>
            <button id="btn-add-rule" class="settings-btn" style="margin-top: 10px;">æ–°å¢</button>
          </div>
           
          <div class="settings-item">
              <div class="settings-sub" style="color:#888; font-size:13px; line-height:1.4;">
                èªªæ˜ï¼šç³»çµ±æœƒæ ¹æ“šå®Œæˆçš„ä»»å‹™æ•¸é‡ï¼Œå–ç¬¦åˆæ¢ä»¶ä¸­ã€Œé»æ•¸æœ€é«˜ã€çš„è¦å‰‡ä¾†è¨ˆç®—æœ¬æ—¥å°è¨ˆã€‚
                <br><strong>æ³¨æ„ï¼šä¿®æ”¹è¦å‰‡ä¸æœƒå½±éŸ¿éå»å·²ç²å¾—çš„åˆ†æ•¸ã€‚</strong>
              </div>
          </div>
        </div>

        <h2>è³‡æ–™é¸é …</h2>
        <div class="card settings-group">
           <div class="settings-item">
            <div>
              <div class="settings-label" style="color:#1565c0;">ğŸ›  ç”¢ç”Ÿæ¸¬è©¦è³‡æ–™</div>
              <div class="settings-sub">éš¨æ©Ÿç”¢ç”Ÿå‰å…©é€±çš„ä»»å‹™ç´€éŒ„(ä¾›æ¸¬è©¦ç”¨)ã€‚</div>
            </div>
            <button id="test-data-btn" class="settings-btn" type="button" style="color:#1565c0;border-color:#bbdefb;">æ¸¬è©¦</button>
          </div>
          
          <div class="settings-item">
            <div>
              <div class="settings-label" style="color:#333;">ğŸ”„ å¼·åˆ¶æ›´æ–°é é¢</div>
              <div class="settings-sub">å¦‚æœç™¼ç¾åŠŸèƒ½ç•°å¸¸æˆ–ç‰ˆæœ¬éèˆŠï¼Œè«‹é»æ­¤é‡æ•´ã€‚</div>
            </div>
            <button onclick="window.location.reload(true)" class="settings-btn" type="button">é‡æ•´</button>
          </div>

          <div class="settings-item">
            <div>
              <div class="settings-label" style="color:#c62828;">é‡ç½®/ç™»å‡º</div>
              <div class="settings-sub">æ¸…é™¤å®¶åº­ä»£è™Ÿèˆ‡æœ¬åœ°ç´€éŒ„ (é›²ç«¯è³‡æ–™ä¿ç•™)ã€‚</div>
            </div>
            <button id="reset-data-btn" class="settings-btn" type="button" style="color:#c62828;border-color:#ffcdd2;">ç™»å‡º</button>
          </div>
        </div>

        <!-- Version ID Display -->
        <div class="version-info" id="version-display">
            v202511271920
        </div>
      </section>
    </main>

    <nav>
      <div class="nav-item active" data-tab-target="today">
        <span class="nav-icon">ğŸ“…</span>
        æœ¬é€±
      </div>
      <div class="nav-item" data-tab-target="rewards">
        <span class="nav-icon">ğŸ</span>
        å…Œæ›
      </div>
      <div class="nav-item" data-tab-target="history">
        <span class="nav-icon">ğŸ“œ</span>
        ç´€éŒ„
      </div>
      <div class="nav-item" data-tab-target="settings">
        <span class="nav-icon">âš™ï¸</span>
        è¨­å®š
      </div>
    </nav>

    <!-- Update Notification Banner -->
    <div id="update-banner" onclick="window.location.reload(true)">
        ğŸš€ ç™¼ç¾æ–°ç‰ˆæœ¬ï¼é»æ­¤æ›´æ–°
    </div>

    <!-- ç·¨è¼¯å°å­© Modal -->
    <div class="modal-overlay" id="edit-kid-modal">
      <div class="modal">
        <h3>ç·¨è¼¯å°å­©è³‡æ–™</h3>
        <input type="hidden" id="edit-kid-key" />
        <div class="form-group">
          <label>é¡¯ç¤ºåç¨± (Name)</label>
          <input id="edit-kid-name" class="small-input" />
        </div>
        <div class="form-group">
          <label>ä¸»é¡Œé¡è‰²</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="edit-kid-theme" value="boy"> è—è‰² (Boy)
            </label>
            <label class="radio-label">
              <input type="radio" name="edit-kid-theme" value="girl"> ç²‰è‰² (Girl)
            </label>
          </div>
        </div>
        <div class="form-group">
          <label>ç›®å‰ç¸½é»æ•¸ (å¯ç›´æ¥ä¿®æ”¹)</label>
          <input id="edit-kid-points" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input" />
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" id="btn-cancel-edit">å–æ¶ˆ</button>
          <button class="btn-save" id="btn-save-edit">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- ç·¨è¼¯ä»»å‹™ Modal -->
    <div class="modal-overlay" id="edit-task-modal">
      <div class="modal">
        <h3>ç·¨è¼¯ä»»å‹™</h3>
        <input type="hidden" id="edit-task-id" />
        <input type="hidden" id="edit-task-type" /> <!-- 'normal' or 'bonus' -->
        <div class="form-group">
          <label>ä»»å‹™åç¨±</label>
          <input id="edit-task-name" class="small-input" />
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" id="btn-cancel-task-edit">å–æ¶ˆ</button>
          <button class="btn-save" id="btn-save-task-edit">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- é€±æ¬¡é¸æ“‡ Modal -->
    <div class="modal-overlay" id="week-select-modal">
        <div class="modal">
            <h3>é¸æ“‡è¦æŸ¥çœ‹çš„é€±æ¬¡</h3>
            <div id="week-list-container"></div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeWeekSelectModal()">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- ç™»å…¥/è¨­å®š ID Modal -->
    <div class="modal-overlay" id="login-modal" style="z-index:99999;">
        <div class="modal" style="max-width:360px;">
            <div class="login-modal-content">
                <div class="login-logo">ğŸ </div>
                <h3>æ­¡è¿ä½¿ç”¨å®¶åº­é»æ•¸æ¿</h3>
                <p class="login-desc">
                    è«‹è¼¸å…¥ä¸€å€‹ç¨ç‰¹çš„<b>ã€Œå®¶åº­ä»£è™Ÿã€</b><br>
                    (ä¾‹å¦‚: <code>wang-home-2025</code>)<br>
                    å…¶ä»–å®¶äººè¼¸å…¥ç›¸åŒä»£è™Ÿå³å¯åŒæ­¥è³‡æ–™ã€‚
                </p>
                <input id="login-family-id" class="login-input" placeholder="è«‹è¼¸å…¥å®¶åº­ä»£è™Ÿ" />
                <button id="login-btn" class="login-btn">é–‹å§‹ä½¿ç”¨</button>
            </div>
        </div>
    </div>
    
    <!-- ç‰¹æ•ˆå…ƒç´  -->
    <div id="coin-effect" class="coin-effect">ğŸª™</div>
    <div id="deduct-effect" class="deduct-effect">ğŸ”»</div>

  </div>

  <script type="module">
    // -----------------------------------------------------------
    // 1. Firebase åˆå§‹åŒ– & Phase 4: Family ID Isolation
    // -----------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs, onSnapshot, getDoc, deleteDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const APP_VERSION = "202511271920";

    const firebaseConfig = {
      apiKey: "AIzaSyDY2SKqPdeB181tALUJE1jr9BtAHN3wUdw",
      authDomain: "familypoints-a51f1.firebaseapp.com",
      projectId: "familypoints-a51f1",
      storageBucket: "familypoints-a51f1.firebasestorage.app",
      messagingSenderId: "1087519864570",
      appId: "1:1087519864570:web:d64e17a153109664b23b43"
    };

    let app, db, auth;
    // Fix: Add global listener variables to handle unsubscription
    let unsubscribeKids = null;
    let unsubscribeRules = null;

    const dbStatusEl = document.getElementById('db-status');
    const versionEl = document.getElementById('version-display');
    const updateBanner = document.getElementById('update-banner');
    
    // --- Global State ---
    var STORAGE_KEY = 'family_points_data_v11';
    var FAMILY_ID_KEY = 'family_points_id';
    var currentFamilyId = localStorage.getItem(FAMILY_ID_KEY) || null;

    if(versionEl) {
        let displayVer = "v" + APP_VERSION;
        if(currentFamilyId) displayVer += " | ID: " + currentFamilyId;
        // é¡¯ç¤ºç³»çµ±æ™‚é–“ä¾›é™¤éŒ¯
        displayVer += "<br>ç³»çµ±èªå®šä»Šå¤©: " + formatDateKey(new Date());
        versionEl.innerHTML = displayVer;
    }

    var defaultRules = [{ threshold: 3, points: 2 }, { threshold: 1, points: 1 }];
    var rulesState = JSON.parse(JSON.stringify(defaultRules));
    
    var defaultCommonTasks = [
      { id: 'dress', name: 'è‡ªå·±ç©¿å¥½è¡£æœ' },
      { id: 'hw',    name: 'å¯«å®Œå›å®¶ä½œæ¥­' },
      { id: 'toys',  name: 'ç¡å‰æ”¶ç©å…·' }
    ];

    var defaultKidsState = {
      leo: {
        key: 'leo', displayName: 'Leo', avatar: 'L', slogan: 'ä»Šå¤©ä¸€èµ·åŠ æ²¹ ğŸ’ª', theme: 'boy',
        totalPoints: 0, dataByWeek: {}, history: [], 
        tasks: JSON.parse(JSON.stringify(defaultCommonTasks)),
        bonusTasks: [] // New: Bonus tasks container
      },
      natasha: {
        key: 'natasha', displayName: 'Natasha', avatar: 'N', slogan: 'ä¸€èµ·é–‹å¿ƒç©è€ ğŸŒˆ', theme: 'girl',
        totalPoints: 0, dataByWeek: {}, history: [], 
        tasks: JSON.parse(JSON.stringify(defaultCommonTasks)),
        bonusTasks: [] // New: Bonus tasks container
      }
    };
    var kidsState = JSON.parse(JSON.stringify(defaultKidsState));
    var currentKid = 'leo';
    var currentViewWeekKey = getCurrentWeekKey();

    // -----------------------------------------------------------
    // Update Checker Logic
    // -----------------------------------------------------------
    async function checkForUpdates() {
        try {
            // Fetch own URL with cache buster
            const url = window.location.href.split('#')[0] + '?t=' + Date.now();
            const response = await fetch(url, { cache: "no-store" });
            const text = await response.text();
            
            // Extract APP_VERSION from fetched HTML
            const match = text.match(/const APP_VERSION = "(\d+)";/);
            if (match && match[1]) {
                const latestVersion = match[1];
                if (latestVersion !== APP_VERSION) {
                    console.log(`New version found: ${latestVersion} (Current: ${APP_VERSION})`);
                    if(updateBanner) {
                        updateBanner.innerHTML = `ğŸš€ ç™¼ç¾æ–°ç‰ˆæœ¬ (v${latestVersion.slice(-4)})ï¼é»æ­¤æ›´æ–°`;
                        updateBanner.style.display = 'block';
                    }
                }
            }
        } catch (e) {
            // console.log("Update check failed"); // Silenced to avoid confusion in preview
        }
    }

    // -----------------------------------------------------------
    // Initialization Logic
    // -----------------------------------------------------------
    async function initApp() {
        // Run update check immediately
        checkForUpdates();
        
        // Listen for visibility change (when user switches back to app)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                checkForUpdates();
            }
        });

        // Step 0: Check Family ID before anything else
        if (!currentFamilyId) {
            showLoginModal();
            return; // Stop here until logged in
        }

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            
            // --- New: Enable Offline Persistence ---
            try {
                await enableIndexedDbPersistence(db);
                console.log("Offline persistence enabled");
            } catch (err) {
                if (err.code == 'failed-precondition') {
                    console.log("Persistence failed: Multiple tabs open");
                } else if (err.code == 'unimplemented') {
                    console.log("Persistence not supported by browser");
                }
            }
            // ---------------------------------------

            auth = getAuth(app);

            // 1. Auth First
            await signInAnonymously(auth);
            console.log("Firebase Auth Success");
            
            // Check initial network status for UI
            updateConnectionStatus(navigator.onLine ? 'online' : 'offline');
            
            // Listen for network changes (Browser level)
            window.addEventListener('online', () => {
                console.log("Network back online");
                updateConnectionStatus('online');
            });
            window.addEventListener('offline', () => {
                console.log("Network lost");
                updateConnectionStatus('offline');
            });

            // 2. Migration Check (Scoped to Family ID)
            await checkAndMigrateData();

            // 3. Setup Listeners (Scoped to Family ID)
            setupRealtimeListeners();
            
            // 4. Initial Scroll to Today (after data loaded/rendered)
            // Since data loads async, we can only try, but real scroll happens after renderAll
            // which is triggered by listeners.

        } catch (e) {
            console.error("Firebase Init/Auth Error:", e);
            updateConnectionStatus('offline');
            // Fallback: load local data if cloud fails
            loadLocalDataOnly();
            renderAll();
        }
    }

    // Login UI Logic
    const loginModal = document.getElementById('login-modal');
    const loginBtn = document.getElementById('login-btn');
    const loginInput = document.getElementById('login-family-id');

    function showLoginModal() {
        loginModal.classList.add('open');
        // Prevent closing by clicking background
        loginModal.onclick = null;
    }

    if(loginBtn) {
        loginBtn.addEventListener('click', function() {
            const val = loginInput.value.trim();
            if(val.length < 3) {
                alert("å®¶åº­ä»£è™Ÿè‡³å°‘éœ€è¦ 3 å€‹å­—å…ƒ");
                return;
            }
            // é©—è­‰è¼¸å…¥å…§å®¹ï¼šåªå…è¨±è‹±æ–‡ã€æ•¸å­—å’Œæ¸›è™Ÿ
            if (!/^[a-zA-Z0-9-]+$/.test(val)) {
                alert("å®¶åº­ä»£è™Ÿåªèƒ½åŒ…å«è‹±æ–‡ã€æ•¸å­—å’Œæ¸›è™Ÿ (-)ï¼Œè«‹å‹¿ä½¿ç”¨ç©ºæ ¼æˆ–ç‰¹æ®Šç¬¦è™Ÿ");
                return;
            }

            // Save ID
            currentFamilyId = val;
            localStorage.setItem(FAMILY_ID_KEY, currentFamilyId);
            loginModal.classList.remove('open');
            
            // Update UI Version Display right away
            if(versionEl) {
                let displayVer = "v" + APP_VERSION;
                if(currentFamilyId) displayVer += " | ID: " + currentFamilyId;
                displayVer += "<br>ç³»çµ±èªå®šä»Šå¤©: " + formatDateKey(new Date());
                versionEl.innerHTML = displayVer;
            }

            // [Modified] Instead of reload, just initApp directly
            initApp();
        });
    }

    // æª¢æŸ¥é›²ç«¯æ˜¯å¦ç‚ºç©ºï¼Œè‹¥æ˜¯å‰‡ä¸Šå‚³ LocalStorage è³‡æ–™
    async function checkAndMigrateData() {
        if (!currentFamilyId) return;

        try {
            // New Path: families/{familyId}/kids
            const kidsRef = collection(db, 'families', currentFamilyId, 'kids');
            const snapshot = await getDocs(kidsRef);

            if (snapshot.empty) {
                console.log("Family cloud space is empty. Migrating local data...");
                updateConnectionStatus('syncing');

                // å…ˆè®€å–æœ¬åœ°è³‡æ–™ (Use existing data in localStorage as seed)
                loadLocalDataOnly(); 

                // ä¸Šå‚³ Kids
                const uploadPromises = Object.values(kidsState).map(kid => {
                    return setDoc(doc(db, 'families', currentFamilyId, 'kids', kid.key), kid);
                });

                // ä¸Šå‚³ Rules
                const rulesPromise = setDoc(doc(db, 'families', currentFamilyId, 'settings', 'rules'), { list: rulesState });

                await Promise.all([...uploadPromises, rulesPromise]);
                console.log("Migration Complete for Family: " + currentFamilyId);
                showToast("å®¶åº­è³‡æ–™åˆå§‹åŒ–å®Œæˆ");
                updateConnectionStatus('online');
            } else {
                console.log("Cloud data found for this family. Skipping migration.");
            }
        } catch (e) {
            console.error("Migration failed:", e);
        }
    }

    // è¨­å®šç›£è½å™¨ï¼šç•¶é›²ç«¯è³‡æ–™è®Šæ›´æ™‚ï¼Œè‡ªå‹•æ›´æ–°æœ¬åœ°è®Šæ•¸ä¸¦é‡ç¹ª
    function setupRealtimeListeners() {
        if (!currentFamilyId) return;

        // Fix: Check and unsubscribe previous listeners to avoid duplication
        if (unsubscribeKids) {
            unsubscribeKids();
            unsubscribeKids = null;
        }
        if (unsubscribeRules) {
            unsubscribeRules();
            unsubscribeRules = null;
        }

        // 1. Listen to Kids Collection
        unsubscribeKids = onSnapshot(collection(db, 'families', currentFamilyId, 'kids'), (snapshot) => {
            if(snapshot.empty && !Object.keys(kidsState).length) return;
            
            const newKidsState = {};
            snapshot.forEach(doc => {
                newKidsState[doc.id] = doc.data();
            });
            
            // Merge logic
            kidsState = newKidsState;
            
            if (!kidsState[currentKid]) {
                const keys = Object.keys(kidsState);
                if(keys.length > 0) currentKid = keys[0];
                else currentKid = null; // Ensure safely handled if no kids
            }

            console.log("Received update (Kids)");
            renderAll();
            // Try scrolling to today on fresh data load
            highlightTodayColumn();
        }, (error) => {
            console.error("Listen failed:", error);
            updateConnectionStatus('offline');
        });

        // 2. Listen to Rules
        unsubscribeRules = onSnapshot(doc(db, 'families', currentFamilyId, 'settings', 'rules'), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.list) {
                    rulesState = data.list;
                    console.log("Received update (Rules)");
                    renderAll();
                }
            }
        });
    }

    function loadLocalDataOnly() {
        var raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
            try {
                var data = JSON.parse(raw);
                if (data.kids) kidsState = data.kids;
                if (data.rules) rulesState = data.rules;
            } catch (e) { console.error('Local Load failed', e); }
        }
    }

    function updateConnectionStatus(status) {
        if(dbStatusEl) {
            let className = 'connection-dot ' + status;
            dbStatusEl.className = className;
            if(status === 'online') dbStatusEl.title = "å·²é€£ç·š (åŒæ­¥ä¸­)";
            else if(status === 'syncing') dbStatusEl.title = "è³‡æ–™åŒæ­¥ä¸­...";
            else dbStatusEl.title = "é›¢ç·š";
        }
    }

    // -----------------------------------------------------------
    // 2. åŸæœ‰ç¨‹å¼é‚è¼¯ (Helper Functions)
    // -----------------------------------------------------------

    document.addEventListener('gesturestart', function (e) { e.preventDefault(); }, { passive: false });
    document.addEventListener('gesturechange', function (e) { e.preventDefault(); }, { passive: false });
    document.addEventListener('gestureend', function (e) { e.preventDefault(); }, { passive: false });
    document.addEventListener('touchmove', function(event) {
        if (event.touches.length > 1) { event.preventDefault(); }
    }, { passive: false });

    function showToast(msg) {
      var toast = document.getElementById('toast-msg');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-msg';
        toast.style.position = 'fixed';
        toast.style.bottom = '80px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = 'rgba(0,0,0,0.8)';
        toast.style.color = '#fff';
        toast.style.padding = '10px 20px';
        toast.style.borderRadius = '20px';
        toast.style.zIndex = '9999';
        toast.style.fontSize = '14px';
        toast.style.transition = 'opacity 0.5s';
        toast.style.opacity = '0';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.style.opacity = '1';
      setTimeout(function() { toast.style.opacity = '0'; }, 2000);
    }
    
    function playCoinSound() {
        var AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        var ctx = new AudioContext();
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'square';
        osc.frequency.setValueAtTime(987.77, ctx.currentTime); 
        osc.frequency.setValueAtTime(1318.51, ctx.currentTime + 0.08);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
        osc.start(); osc.stop(ctx.currentTime + 0.4);
    }
    function showCoinAnimation() {
        var coin = document.getElementById('coin-effect');
        if(coin) { coin.classList.remove('animate'); void coin.offsetWidth; coin.classList.add('animate'); }
    }
    function playDeductSound() {
        var AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        var ctx = new AudioContext();
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(300, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start(); osc.stop(ctx.currentTime + 0.3);
    }
    function showDeductAnimation() {
        var elem = document.getElementById('deduct-effect');
        if(elem) { elem.classList.remove('animate'); void elem.offsetWidth; elem.classList.add('animate'); }
    }

    var navItems = document.querySelectorAll('.nav-item');
    var pages = document.querySelectorAll('.tab-page');
    navItems.forEach(function(item) {
      item.addEventListener('click', function() {
        var target = item.getAttribute('data-tab-target');
        navItems.forEach(function(n) { n.classList.remove('active'); });
        item.classList.add('active');
        pages.forEach(function(page) {
          if (page.getAttribute('data-tab') === target) page.classList.add('active');
          else page.classList.remove('active');
        });
        if(target === 'today') setTimeout(highlightTodayColumn, 100);
      });
    });

    function getMonday(d) {
        d = new Date(d);
        var day = d.getDay();
        var diff = d.getDate() - day + (day == 0 ? -6 : 1);
        var monday = new Date(d.setDate(diff));
        monday.setHours(0,0,0,0);
        return monday;
    }
    function formatDateKey(d) {
        var year = d.getFullYear();
        var month = (d.getMonth() + 1).toString().padStart(2, '0');
        var day = d.getDate().toString().padStart(2, '0');
        return year + '-' + month + '-' + day;
    }
    function getCurrentWeekKey() {
        return formatDateKey(getMonday(new Date()));
    }
    function getWeekRangeString(mondayStr) {
        var monday = new Date(mondayStr);
        var sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        return (monday.getMonth()+1) + '/' + monday.getDate() + " ï½ " + (sunday.getMonth()+1) + '/' + sunday.getDate();
    }

    // Phase 4: Scoped Write Implementation
    async function saveData(type, id) {
      if (!currentFamilyId) return;

      triggerSaveIndicator();
      
      try {
        if (type === 'kid' && id) {
            const kidData = kidsState[id];
            if(kidData) {
                await setDoc(doc(db, 'families', currentFamilyId, 'kids', id), kidData);
                console.log(`Saved kid: ${id} to family: ${currentFamilyId}`);
            }
        } else if (type === 'delete_kid' && id) {
            await deleteDoc(doc(db, 'families', currentFamilyId, 'kids', id));
            console.log(`Deleted kid: ${id}`);
        } else if (type === 'rules') {
            await setDoc(doc(db, 'families', currentFamilyId, 'settings', 'rules'), { list: rulesState });
            console.log(`Saved rules`);
        } else {
            // Fallback
            if (currentKid && kidsState[currentKid]) {
                await setDoc(doc(db, 'families', currentFamilyId, 'kids', currentKid), kidsState[currentKid]);
            }
        }
      } catch(e) {
          console.error("Cloud save failed:", e);
          showToast("é›²ç«¯å­˜æª”å¤±æ•—");
          updateConnectionStatus('offline');
      }
    }

    function triggerSaveIndicator() {
        var badge = document.getElementById('save-badge');
        if(badge) {
            badge.classList.add('show');
            setTimeout(function(){ badge.classList.remove('show'); }, 1500);
        }
    }

    function calculateDailyScoreDetail(kid, weekKey, dayIndex) {
        // New combined calculation function
        var weekData = getWeekData(kid, weekKey);
        if (!weekData.ruleScores) weekData.ruleScores = [0,0,0,0,0,0,0]; // For caching visual
        
        var dayStatus = weekData.status[dayIndex] || {};
        
        // 1. Calculate Rule Score (Normal Tasks)
        var checkedNormalCount = 0;
        
        // Let's iterate kid.tasks (source of truth for normal tasks)
        kid.tasks.forEach(t => {
            if (dayStatus[t.id] === 'checked') checkedNormalCount++;
        });
        
        var ruleScore = 0;
        var maxPoints = 0;
        var matched = false;
        rulesState.forEach(function(rule) {
            if (checkedNormalCount >= rule.threshold) {
                if (rule.points > maxPoints) {
                    maxPoints = rule.points;
                    matched = true;
                }
            }
        });
        if (matched) ruleScore = maxPoints;

        // 2. Calculate Bonus Score (Bonus Tasks)
        var bonusScore = 0;
        if (kid.bonusTasks) {
            kid.bonusTasks.forEach(bt => {
                if (dayStatus[bt.id] === 'checked') bonusScore++; // Each bonus task = +1
            });
        }

        var manualPoints = weekData.summary[dayIndex] || 0;
        
        return {
            ruleScore: ruleScore,
            bonusScore: bonusScore,
            manualPoints: manualPoints,
            total: ruleScore + bonusScore + manualPoints
        };
    }

    function calculateDailyTotal(kid, weekKey, dayIndex) {
      return calculateDailyScoreDetail(kid, weekKey, dayIndex).total;
    }

    // Keep this for visual consistency in rendering (though calculateDailyScoreDetail does the real work now)
    function computeRuleScoreForDay(dayStatus) {
        // This old function is less useful now, logic moved to calculateDailyScoreDetail
        // Kept just in case, but essentially deprecated by new logic
        return 0; 
    }

    function performReset() {
      // Logout logic
      if(confirm('ç¢ºå®šè¦ç™»å‡ºä¸¦æ¸…é™¤æœ¬æ©Ÿç´€éŒ„å—ï¼Ÿ\n(æ‚¨çš„é›²ç«¯è³‡æ–™ä»æœƒä¿ç•™åœ¨è©²å®¶åº­ä»£è™Ÿä¸‹)')) {
          localStorage.removeItem(FAMILY_ID_KEY);
          localStorage.removeItem(STORAGE_KEY);
          window.location.reload();
      }
    }
    
    function handleTestDataGen() {
        if(!confirm('é€™å°‡æœƒç‚ºç›®å‰çš„å°å­©ã€Œéš¨æ©Ÿç”¢ç”Ÿå‰å…©é€±çš„ä»»å‹™ç´€éŒ„(å«Bonus)ã€ã€‚ç¢ºå®šå—ï¼Ÿ')) return;
        
        var kid = kidsState[currentKid];
        var today = new Date();
        var addedPoints = 0;

        for(var w=1; w<=2; w++) {
            var pastDate = new Date(today);
            pastDate.setDate(today.getDate() - (w*7));
            var monday = getMonday(pastDate);
            var key = formatDateKey(monday);
            
            if(!kid.dataByWeek[key]) {
                kid.dataByWeek[key] = {
                    status: [{},{},{},{},{},{},{}],
                    summary: [0,0,0,0,0,0,0],
                    ruleScores: [0,0,0,0,0,0,0]
                };
            }
            
            var weekData = kid.dataByWeek[key];
            if(!weekData.status) weekData.status = [{},{},{},{},{},{},{}];
            if(!weekData.ruleScores) weekData.ruleScores = [0,0,0,0,0,0,0];
            
            for(var day=0; day<7; day++) {
                var oldScore = weekData.ruleScores[day]; // This is actually cached total score, reusing field
                
                // Normal Tasks
                kid.tasks.forEach(task => {
                    if(Math.random() > 0.4) { 
                        if(!weekData.status[day]) weekData.status[day] = {};
                        weekData.status[day][task.id] = 'checked';
                    }
                });
                // Bonus Tasks
                if(kid.bonusTasks) {
                    kid.bonusTasks.forEach(task => {
                        if(Math.random() > 0.7) { // Lower chance for bonus
                            if(!weekData.status[day]) weekData.status[day] = {};
                            weekData.status[day][task.id] = 'checked';
                        }
                    });
                }

                // Recalculate
                var details = calculateDailyScoreDetail(kid, key, day);
                weekData.ruleScores[day] = details.total; // We store total here for simple caching
            }
        }
        
        saveData('kid', currentKid);
        renderAll();
        showToast('å·²ç”Ÿæˆæ¸¬è©¦è³‡æ–™');
    }
    
    function renderAll() {
        renderCurrentKid();
        renderWeekTable();
        renderHistoryList();
        renderSettingsTaskList();
        renderSettingsBonusTaskList(); // New
        renderSettingsKidList();
        renderSettingsRulesList(); 
    }

    var appEl = document.querySelector('.app');
    var switchBtn = document.querySelector('.switch-btn');
    var kidNameEl = document.querySelector('.kid-name');
    var avatarEl = document.querySelector('.avatar');
    var kidSubEl = document.querySelector('.kid-sub');
    var totalPointsEl = document.getElementById('total-points');
    var weeklyPointsEl = document.getElementById('weekly-points');
    var dateChipEl = document.getElementById('date-chip');
    var viewLabelEl = document.getElementById('viewing-week-label'); 
    var historyWeekLabel = document.getElementById('history-week-label');
    var settingsTaskKidLabel = document.getElementById('settings-task-kid-label'); 

    var redeemKidNameEl = document.getElementById('redeem-kid-name');
    var redeemKidPointsEl = document.getElementById('redeem-kid-points');
    var redeemNameInput = document.getElementById('redeem-name-input');
    var redeemPointsInput = document.getElementById('redeem-points-input');
    var redeemNoteInput = document.getElementById('redeem-note-input');
    var redeemConfirmBtn = document.getElementById('redeem-confirm-btn');
    
    var quickNoteInput = document.getElementById('quick-note-input');
    var historyCard = document.getElementById('points-history-card');
    
    var settingsTaskListEl = document.getElementById('settings-task-list');
    var settingsNewTaskInput = document.getElementById('settings-new-task-input');
    var settingsNewTaskBtn = document.getElementById('settings-new-task-btn');
    var settingsKidListEl = document.getElementById('settings-kid-list');
    
    // New Settings Elements for Bonus
    var settingsBonusTaskListEl = document.getElementById('settings-bonus-task-list');
    var settingsNewBonusTaskInput = document.getElementById('settings-new-bonus-task-input');
    var settingsNewBonusTaskBtn = document.getElementById('settings-new-bonus-task-btn');

    var settingsRulesListEl = document.getElementById('settings-rules-list');
    var ruleThresholdInput = document.getElementById('rule-threshold-input');
    var rulePointsInput = document.getElementById('rule-points-input');
    var btnAddRule = document.getElementById('btn-add-rule');

    var editKidModal = document.getElementById('edit-kid-modal');
    var editKidKeyInput = document.getElementById('edit-kid-key');
    var editKidNameInput = document.getElementById('edit-kid-name');
    var editKidPointsInput = document.getElementById('edit-kid-points');
    var btnCancelEdit = document.getElementById('btn-cancel-edit');
    var btnSaveEdit = document.getElementById('btn-save-edit');
    var resetDataBtn = document.getElementById('reset-data-btn');
    var testDataBtn = document.getElementById('test-data-btn');
    var weekSelectModal = document.getElementById('week-select-modal');
    var weekListContainer = document.getElementById('week-list-container');

    // Vars for Task Edit Modal
    var editTaskModal = document.getElementById('edit-task-modal');
    var editTaskIdInput = document.getElementById('edit-task-id');
    var editTaskTypeInput = document.getElementById('edit-task-type');
    var editTaskNameInput = document.getElementById('edit-task-name');
    var btnCancelTaskEdit = document.getElementById('btn-cancel-task-edit');
    var btnSaveTaskEdit = document.getElementById('btn-save-task-edit');

    if (resetDataBtn) {
      resetDataBtn.addEventListener('click', function() {
          performReset();
      });
    }

    if (testDataBtn) {
        testDataBtn.addEventListener('click', handleTestDataGen);
    }

    function formatDailySummary(value) { return (value >= 0 ? '+' : '') + value; }
    function getTodayColumnIndex() {
      var d = new Date().getDay();
      return (d === 0) ? 6 : d - 1; 
    }

    function getWeekData(kid, weekKey) {
        if(!kid.dataByWeek[weekKey]) {
            kid.dataByWeek[weekKey] = {
                status: [{},{},{},{},{},{},{}],
                summary: [0,0,0,0,0,0,0],
                ruleScores: [0,0,0,0,0,0,0]
            };
        }
        return kid.dataByWeek[weekKey];
    }

    function calculateWeeklyGridPoints(kid, weekKey) {
        let total = 0;
        for (let i = 0; i < 7; i++) {
            total += calculateDailyTotal(kid, weekKey, i);
        }
        return total;
    }

    function renderCurrentKid() {
        // Safety check if kid was deleted remotely
        if (!kidsState[currentKid]) {
            if(Object.keys(kidsState).length > 0) currentKid = Object.keys(kidsState)[0];
            else return; // No kids data
        }

        var kid = kidsState[currentKid];
        
        // Ensure bonusTasks exists (migration safety)
        if (!kid.bonusTasks) kid.bonusTasks = [];

        kidNameEl.textContent = kid.displayName;
        if(currentFamilyId) {
             var idTag = document.createElement('span');
             idTag.className = 'family-id-tag';
             idTag.textContent = currentFamilyId;
        }
        
        var firstChild = avatarEl.firstChild;
        if(firstChild && firstChild.nodeType === 3) {
            firstChild.textContent = kid.avatar;
        } else if (!firstChild) {
            avatarEl.prepend(document.createTextNode(kid.avatar));
        }

        kidSubEl.textContent = kid.slogan;
        appEl.classList.remove('boy', 'girl');
        appEl.classList.add(kid.theme);
        totalPointsEl.innerHTML = '<span>â­</span><span>' + kid.totalPoints + ' é»</span>';
        
        const weeklyScore = calculateWeeklyGridPoints(kid, currentViewWeekKey);
        weeklyPointsEl.textContent = `æœ¬é€±ï¼š${weeklyScore} é»`;

        dateChipEl.textContent = 'é€±æ¬¡ï¼š' + getWeekRangeString(currentViewWeekKey);
        var thisWeek = getCurrentWeekKey();
        if(currentViewWeekKey === thisWeek) {
            viewLabelEl.textContent = "(æœ¬é€±)";
            viewLabelEl.style.color = "#2e7d32";
            historyWeekLabel.textContent = "(æœ¬é€±)";
        } else {
            viewLabelEl.textContent = "(æ­·å²ç´€éŒ„)";
            viewLabelEl.style.color = "#c62828";
            historyWeekLabel.textContent = `(${getWeekRangeString(currentViewWeekKey)})`;
        }
        redeemKidNameEl.textContent = kid.displayName;
        redeemKidPointsEl.textContent = kid.totalPoints;
        if(settingsTaskKidLabel) settingsTaskKidLabel.textContent = "(ç®¡ç†å°è±¡ï¼š" + kid.displayName + ")";
    }

    function renderWeekTable() {
        if (!kidsState[currentKid]) return;
        var kid = kidsState[currentKid];
        var table = document.getElementById('week-table');
        table.innerHTML = '';
        var weekData = getWeekData(kid, currentViewWeekKey);

        var days = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
        var todayIdx = getTodayColumnIndex();
        var isCurrentWeek = (currentViewWeekKey === getCurrentWeekKey());

        var headerRow = document.createElement('div');
        headerRow.className = 'week-header';
        
        var corner = document.createElement('div');
        corner.className = 'task-name-header';
        corner.textContent = 'ä»»å‹™ / æ˜ŸæœŸ';
        headerRow.appendChild(corner);

        var mondayDate = new Date(currentViewWeekKey);

        days.forEach(function(d, i) {
            var cell = document.createElement('div');
            cell.className = 'day-header';
            if (isCurrentWeek && i === todayIdx) cell.classList.add('today-col');
            var thisDay = new Date(mondayDate);
            thisDay.setDate(mondayDate.getDate() + i);
            var dateStr = (thisDay.getMonth()+1) + '/' + thisDay.getDate();
            cell.innerHTML = `<div>${d}</div><div class="date-label">${dateStr}</div>`;
            headerRow.appendChild(cell);
        });
        table.appendChild(headerRow);

        // --- Helper to filter tasks ---
        function getVisibleTasks(taskList) {
            return taskList.filter(function(t) {
                if (!t.deleted) return true;
                var hasDataInWeek = weekData.status.some(function(dayStatus) {
                    return dayStatus && (dayStatus[t.id] === 'checked' || dayStatus[t.id] === 'crossed');
                });
                return hasDataInWeek;
            });
        }

        // 1. Normal Tasks
        var normalTasks = getVisibleTasks(kid.tasks);
        normalTasks.forEach(function(task) {
            renderTaskRow(task, 'normal', weekData, todayIdx);
        });

        // 2. Separator if needed
        var bonusTasks = getVisibleTasks(kid.bonusTasks || []);
        if (bonusTasks.length > 0) {
            var sep = document.createElement('div');
            sep.className = 'bonus-separator';
            sep.textContent = 'â­ BONUS ä»»å‹™å€ â­';
            table.appendChild(sep);
        }

        // 3. Bonus Tasks
        bonusTasks.forEach(function(task) {
            renderTaskRow(task, 'bonus', weekData, todayIdx);
        });

        // --- Footer Row (Summary) ---
        var sumRow = document.createElement('div');
        sumRow.className = 'day-summary-row';
        var sumTitle = document.createElement('div');
        sumTitle.className = 'task-name-summary';
        sumTitle.textContent = 'æœ¬æ—¥å°è¨ˆ';
        sumRow.appendChild(sumTitle);

        for (var i=0; i<7; i++) {
            var cell = document.createElement('div');
            cell.className = 'day-summary-cell';
            if (isCurrentWeek && i === todayIdx) cell.classList.add('today-col');
            var dailyTotal = calculateDailyTotal(kid, currentViewWeekKey, i);
            var scoreSpan = document.createElement('span');
            scoreSpan.textContent = (dailyTotal > 0 ? '+' : '') + dailyTotal;
            if(dailyTotal > 0) scoreSpan.className = 'day-summary-cell-positive';
            if(dailyTotal < 0) scoreSpan.className = 'day-summary-cell-negative';
            cell.appendChild(scoreSpan);
            sumRow.appendChild(cell);
        }
        table.appendChild(sumRow);
    }

    function renderTaskRow(task, type, weekData, todayIdx) {
        var table = document.getElementById('week-table');
        var row = document.createElement('div');
        row.className = 'task-row ' + (type === 'bonus' ? 'bonus-row' : '');

        var nameCell = document.createElement('div');
        nameCell.className = 'task-name';
        if (task.deleted) {
            nameCell.textContent = task.name + " (å·²å°å­˜)";
            nameCell.style.color = "#999";
            nameCell.style.fontStyle = "italic";
        } else {
            nameCell.textContent = task.name;
            // Long press delete
            var pressTimer;
            nameCell.addEventListener('touchstart', function(){
                pressTimer = setTimeout(function(){
                    if(confirm(`è¦åˆªé™¤ä»»å‹™ã€Œ${task.name}ã€å—ï¼Ÿ(æ­·å²ç´€éŒ„ä¿ç•™)`)) {
                        deleteTask(task.id, type);
                    }
                }, 800);
            });
            nameCell.addEventListener('touchend', function(){ clearTimeout(pressTimer); });
        }
        row.appendChild(nameCell);

        for (var i=0; i<7; i++) {
            var cellWrapper = document.createElement('div');
            cellWrapper.className = 'day-cell-wrapper';
            if (currentViewWeekKey === getCurrentWeekKey() && i === todayIdx) cellWrapper.classList.add('today-col');

            var check = document.createElement('div');
            var status = (weekData.status[i] && weekData.status[i][task.id]) ? weekData.status[i][task.id] : '';
            check.className = 'custom-check ' + (status === 'checked' ? 'checked' : (status === 'crossed' ? 'crossed' : ''));
            check.textContent = status === 'checked' ? 'âœ”' : (status === 'crossed' ? 'âœ–' : '');
            
            (function(dIndex, taskId, tType) {
                check.onclick = function() {
                    toggleCheck(dIndex, taskId, tType);
                };
            })(i, task.id, type);

            cellWrapper.appendChild(check);
            row.appendChild(cellWrapper);
        }
        table.appendChild(row);
    }

    function toggleCheck(dayIndex, taskId, type) {
        var kid = kidsState[currentKid];
        var detailsBefore = calculateDailyScoreDetail(kid, currentViewWeekKey, dayIndex);
        var oldTotal = detailsBefore.total;

        var weekData = getWeekData(kid, currentViewWeekKey);
        
        var current = (weekData.status[dayIndex] && weekData.status[dayIndex][taskId]) ? weekData.status[dayIndex][taskId] : '';
        var next = '';
        if (current === '') next = 'checked';
        else if (current === 'checked') next = 'crossed'; // Or just empty for bonus? let's keep crossed for consistancy
        else next = '';

        // For Bonus, maybe crossed isn't needed, just toggle on/off? 
        // Let's stick to standard behavior for consistency first.

        if (!weekData.status[dayIndex]) weekData.status[dayIndex] = {};
        weekData.status[dayIndex][taskId] = next;

        // Recalculate
        var detailsAfter = calculateDailyScoreDetail(kid, currentViewWeekKey, dayIndex);
        var newTotal = detailsAfter.total;
        
        // Cache result for quick lookups (though we calculate dynamic now)
        weekData.ruleScores[dayIndex] = newTotal;

        var diff = newTotal - oldTotal;

        if (diff !== 0) {
            kid.totalPoints += diff;
            if(diff > 0) {
                showCoinAnimation();
                playCoinSound();
            } else {
                showDeductAnimation();
                playDeductSound(); 
            }
        }
        saveData('kid', currentKid);
        renderCurrentKid();
        renderWeekTable();
    }

    function handleQuickAdd(val) {
        var kid = kidsState[currentKid];
        var note = quickNoteInput.value.trim();
        kid.totalPoints += val;
        kid.history.push({
            id: Date.now().toString(),
            date: formatDateKey(new Date()), // Use local date
            item: 'å¿«é€ŸåŠ æ‰£',
            delta: val,
            note: note || (val > 0 ? 'æ‰‹å‹•åŠ é»' : 'æ‰‹å‹•æ‰£é»')
        });

        quickNoteInput.value = '';
        if (val > 0) {
            showCoinAnimation();
            playCoinSound();
            showToast('åŠ é»æˆåŠŸï¼');
        } else {
            showDeductAnimation();
            playDeductSound();
            showToast('å·²æ‰£é»');
        }
        saveData('kid', currentKid);
        renderAll();
    }

    redeemConfirmBtn.addEventListener('click', function() {
        var name = redeemNameInput.value.trim();
        var pts = parseInt(redeemPointsInput.value);
        var note = redeemNoteInput.value.trim();
        var kid = kidsState[currentKid];

        if (!name || isNaN(pts) || pts <= 0) {
            alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å…Œæ›åç¨±å’Œé»æ•¸');
            return;
        }
        if (kid.totalPoints < pts) {
            if(!confirm('é»æ•¸ä¸è¶³ï¼Œç¢ºå®šè¦å…Œæ›ä¸¦è®Šæˆè² åˆ†å—ï¼Ÿ')) return;
        }

        kid.totalPoints -= pts;
        kid.history.push({
            id: Date.now().toString(),
            date: formatDateKey(new Date()), // Use local date
            item: 'å…Œæ›ï¼š' + name,
            delta: -pts,
            note: note
        });

        redeemNameInput.value = '';
        redeemPointsInput.value = '';
        redeemNoteInput.value = '';
        showDeductAnimation();
        playDeductSound();
        showToast('å…Œæ›æˆåŠŸï¼');
        saveData('kid', currentKid);
        renderAll();
    });

    // --- Inserted renderHistoryList (Missing in previous version) ---
    function renderHistoryList() {
        if (!kidsState[currentKid]) return;
        var kid = kidsState[currentKid];
        historyCard.innerHTML = '';
        
        var viewMonday = new Date(currentViewWeekKey);
        var viewNextMonday = new Date(viewMonday);
        viewNextMonday.setDate(viewMonday.getDate() + 7);

        var filteredHistory = kid.history.filter(function(item) {
            var itemDate = new Date(item.date);
            return itemDate.getTime() >= viewMonday.getTime() && 
                   itemDate.getTime() < viewNextMonday.getTime();
        });

        var list = filteredHistory.sort(function(a,b){ return b.id - a.id; });

        if (list.length === 0) {
            historyCard.innerHTML = '<div class="empty-state">æœ¬é€±å°šç„¡é¡å¤–ç´€éŒ„</div>';
            return;
        }

        list.forEach(function(h) {
            var row = document.createElement('div');
            row.className = 'history-item';
            
            var left = document.createElement('div');
            left.className = 'history-main';
            var titleDiv = document.createElement('div');
            titleDiv.style.fontWeight = '600';
            titleDiv.textContent = h.item;
            
            var metaDiv = document.createElement('div');
            metaDiv.className = 'history-date';
            var metaText = h.date;
            if(h.note) metaText += ' Â· ' + h.note;
            metaDiv.textContent = metaText;
            
            left.appendChild(titleDiv);
            left.appendChild(metaDiv);

            var right = document.createElement('div');
            right.style.textAlign = 'right';
            
            var deltaDiv = document.createElement('div');
            deltaDiv.className = 'history-delta';
            deltaDiv.textContent = (h.delta > 0 ? '+' : '') + h.delta;
            deltaDiv.style.color = h.delta > 0 ? '#2e7d32' : '#c62828';
            
            var delBtn = document.createElement('button');
            delBtn.className = 'history-delete-btn';
            delBtn.textContent = 'åˆªé™¤';
            delBtn.onclick = function() {
                if(confirm('ç¢ºå®šåˆªé™¤é€™æ¢ç´€éŒ„ï¼Ÿé»æ•¸æœƒå¾©åŸã€‚')) {
                    deleteHistoryItem(h.id, h.delta);
                }
            };

            right.appendChild(deltaDiv);
            right.appendChild(delBtn);
            
            row.appendChild(left);
            row.appendChild(right);
            historyCard.appendChild(row);
        });
    }

    function deleteHistoryItem(id, delta) {
        var kid = kidsState[currentKid];
        kid.history = kid.history.filter(x => x.id !== id);
        kid.totalPoints -= delta; 
        saveData('kid', currentKid);
        renderAll();
        showToast('ç´€éŒ„å·²åˆªé™¤');
    }
    // -------------------------------------------------------------

    function renderSettingsTaskList() {
        renderGenericTaskList(settingsTaskListEl, 'normal');
    }

    function renderSettingsBonusTaskList() {
        renderGenericTaskList(settingsBonusTaskListEl, 'bonus');
    }

    function renderGenericTaskList(container, type) {
        if (!kidsState[currentKid]) return;
        var kid = kidsState[currentKid];
        var list = (type === 'normal') ? kid.tasks : (kid.bonusTasks || []);
        
        container.innerHTML = '';
        list.forEach(function(t) {
            if (t.deleted) return;

            var item = document.createElement('div');
            item.className = 'settings-item';
            
            var nameDiv = document.createElement('div');
            nameDiv.textContent = t.name;
            if(type === 'bonus') nameDiv.style.color = '#e65100'; // Orange for bonus
            item.appendChild(nameDiv);

            var btnDiv = document.createElement('div');
            btnDiv.style.display = 'flex';
            btnDiv.style.gap = '8px';

            var editBtn = document.createElement('button');
            editBtn.className = 'settings-btn';
            editBtn.textContent = 'ç·¨è¼¯';
            editBtn.onclick = function() {
                openEditTaskModal(t.id, t.name, type);
            };
            btnDiv.appendChild(editBtn);

            var delBtn = document.createElement('button');
            delBtn.className = 'settings-btn delete-task-btn';
            delBtn.textContent = 'åˆªé™¤';
            delBtn.onclick = function() {
                if(confirm('ç¢ºå®šåˆªé™¤ã€Œ'+t.name+'ã€ï¼Ÿ(æ­·å²ç´€éŒ„ä¿ç•™)')) {
                    deleteTask(t.id, type);
                }
            };
            btnDiv.appendChild(delBtn);

            item.appendChild(btnDiv);
            container.appendChild(item);
        });
    }

    function deleteTask(taskId, type) {
        var kid = kidsState[currentKid];
        var list = (type === 'bonus') ? kid.bonusTasks : kid.tasks;
        var task = list.find(t => t.id === taskId);
        if (task) {
            task.deleted = true;
            saveData('kid', currentKid);
            renderAll();
            showToast('ä»»å‹™å·²å°å­˜');
        }
    }

    function openEditTaskModal(id, name, type) {
        editTaskIdInput.value = id;
        editTaskNameInput.value = name;
        editTaskTypeInput.value = type; // Store type
        editTaskModal.classList.add('open');
    }

    if(btnCancelTaskEdit) btnCancelTaskEdit.onclick = function() { editTaskModal.classList.remove('open'); };
    
    if(btnSaveTaskEdit) btnSaveTaskEdit.onclick = function() {
        var id = editTaskIdInput.value;
        var type = editTaskTypeInput.value;
        var newName = editTaskNameInput.value.trim();
        if(!newName) return;
        
        var kid = kidsState[currentKid];
        var list = (type === 'bonus') ? kid.bonusTasks : kid.tasks;
        var task = list.find(t => t.id === id);
        
        if(task) {
            task.name = newName;
            saveData('kid', currentKid);
            renderAll();
            showToast('ä»»å‹™åç¨±å·²æ›´æ–°');
        }
        editTaskModal.classList.remove('open');
    };

    settingsNewTaskBtn.addEventListener('click', function() {
        var val = settingsNewTaskInput.value.trim();
        if(!val) return;
        var kid = kidsState[currentKid];
        kid.tasks.push({ id: 't'+Date.now(), name: val, createdAt: new Date().toISOString() });
        settingsNewTaskInput.value = '';
        saveData('kid', currentKid);
        renderAll();
        showToast('ä»»å‹™å·²æ–°å¢');
    });

    if(settingsNewBonusTaskBtn) {
        settingsNewBonusTaskBtn.addEventListener('click', function() {
            var val = settingsNewBonusTaskInput.value.trim();
            if(!val) return;
            var kid = kidsState[currentKid];
            if(!kid.bonusTasks) kid.bonusTasks = [];
            kid.bonusTasks.push({ id: 'b'+Date.now(), name: val, createdAt: new Date().toISOString() });
            settingsNewBonusTaskInput.value = '';
            saveData('kid', currentKid);
            renderAll();
            showToast('Bonus ä»»å‹™å·²æ–°å¢');
        });
    }

    function renderSettingsKidList() {
        settingsKidListEl.innerHTML = '';
        Object.values(kidsState).forEach(function(k) {
            var item = document.createElement('div');
            item.className = 'settings-item';
            var infoDiv = document.createElement('div');
            infoDiv.innerHTML = '<span style="font-weight:600">'+k.displayName+'</span> <span style="font-size:12px;color:#888">('+k.totalPoints+'é»)</span>';
            var btnDiv = document.createElement('div');
            btnDiv.style.display = 'flex';
            btnDiv.style.gap = '8px';
            var editBtn = document.createElement('button');
            editBtn.className = 'settings-btn';
            editBtn.textContent = 'ç·¨è¼¯';
            editBtn.onclick = function() { openEditKidModal(k.key); };
            btnDiv.appendChild(editBtn);
            if (Object.keys(kidsState).length > 1) {
                var delBtn = document.createElement('button');
                delBtn.className = 'settings-btn delete-task-btn';
                delBtn.textContent = 'åˆªé™¤';
                delBtn.onclick = function() {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤å°å­©ã€Œ'+k.displayName+'ã€çš„æ‰€æœ‰è³‡æ–™ï¼Ÿç„¡æ³•å¾©åŸï¼')) {
                        deleteKid(k.key);
                    }
                };
                btnDiv.appendChild(delBtn);
            }
            item.appendChild(infoDiv);
            item.appendChild(btnDiv);
            settingsKidListEl.appendChild(item);
        });
        var addDiv = document.createElement('div');
        addDiv.className = 'settings-item';
        addDiv.style.justifyContent = 'center';
        var addBtn = document.createElement('button');
        addBtn.className = 'settings-btn';
        addBtn.style.width = '100%';
        addBtn.style.color = '#1565c0';
        addBtn.style.fontWeight = '600';
        addBtn.textContent = '+ æ–°å¢å°å­©';
        addBtn.onclick = addNewKid;
        addDiv.appendChild(addBtn);
        settingsKidListEl.appendChild(addDiv);
    }

    function addNewKid() {
        var newKey = 'kid_' + Date.now();
        kidsState[newKey] = {
            key: newKey,
            displayName: 'æ–°å¯¶è²',
            avatar: 'ğŸ™‚',
            slogan: 'å¿«æ¨‚æ¯ä¸€å¤©',
            theme: 'boy',
            totalPoints: 0,
            dataByWeek: {},
            history: [],
            tasks: JSON.parse(JSON.stringify(defaultCommonTasks)),
            bonusTasks: []
        };
        saveData('kid', newKey);
        renderAll();
        showToast('å·²æ–°å¢å°å­©ï¼Œè«‹åˆ°ç·¨è¼¯ä¿®æ”¹è³‡æ–™');
    }

    function deleteKid(key) {
        delete kidsState[key];
        if (currentKid === key) {
            const keys = Object.keys(kidsState);
            if(keys.length > 0) currentKid = keys[0];
            else currentKid = null;
        }
        // ä½¿ç”¨ delete_kid é¡å‹åˆªé™¤é›²ç«¯æ–‡ä»¶
        saveData('delete_kid', key);
        renderAll();
    }

    function openEditKidModal(key) {
        var kid = kidsState[key];
        editKidKeyInput.value = key;
        editKidNameInput.value = kid.displayName;
        editKidPointsInput.value = kid.totalPoints;
        var radios = document.getElementsByName('edit-kid-theme');
        radios.forEach(r => {
            if(r.value === kid.theme) r.checked = true;
        });
        editKidModal.classList.add('open');
    }

    btnCancelEdit.onclick = function() { editKidModal.classList.remove('open'); };
    btnSaveEdit.onclick = function() {
        var key = editKidKeyInput.value;
        var kid = kidsState[key];
        if(!kid) return;
        kid.displayName = editKidNameInput.value.trim() || 'No Name';
        kid.avatar = kid.displayName.charAt(0).toUpperCase();
        kid.totalPoints = parseInt(editKidPointsInput.value) || 0;
        var radios = document.getElementsByName('edit-kid-theme');
        radios.forEach(r => { if(r.checked) kid.theme = r.value; });
        saveData('kid', key);
        renderAll();
        editKidModal.classList.remove('open');
        showToast('è³‡æ–™å·²æ›´æ–°');
    };

    function renderSettingsRulesList() {
        settingsRulesListEl.innerHTML = '';
        rulesState.sort((a,b) => b.threshold - a.threshold).forEach((rule, idx) => {
            var row = document.createElement('div');
            row.className = 'settings-item';
            row.innerHTML = `
                <div>
                   <span style="font-weight:600">å®Œæˆ ${rule.threshold} é …</span>
                   <span style="margin:0 8px">â†’</span>
                   <span style="color:#2e7d32; font-weight:600">+${rule.points} é»</span>
                </div>
            `;
            var delBtn = document.createElement('button');
            delBtn.className = 'settings-btn delete-task-btn';
            delBtn.textContent = 'åˆªé™¤';
            delBtn.onclick = function() {
                rulesState.splice(idx, 1);
                saveData('rules');
                renderAll();
            };
            row.appendChild(delBtn);
            settingsRulesListEl.appendChild(row);
        });
    }

    btnAddRule.addEventListener('click', function() {
        var t = parseInt(ruleThresholdInput.value);
        var p = parseInt(rulePointsInput.value);
        if(isNaN(t) || isNaN(p)) return;
        rulesState.push({ threshold: t, points: p });
        ruleThresholdInput.value = '';
        rulePointsInput.value = '';
        saveData('rules');
        renderAll();
        showToast('è¦å‰‡å·²æ–°å¢');
    });

    switchBtn.addEventListener('click', function() {
        var keys = Object.keys(kidsState);
        if(keys.length === 0) return;
        var idx = keys.indexOf(currentKid);
        var nextIdx = (idx + 1) % keys.length;
        currentKid = keys[nextIdx];
        renderAll();
    });

    function openWeekSelectModal() {
        if (!kidsState[currentKid]) return;
        weekListContainer.innerHTML = '';
        var kid = kidsState[currentKid];
        var weeks = Object.keys(kid.dataByWeek).sort().reverse();
        var thisWeek = getCurrentWeekKey();
        if (!weeks.includes(thisWeek)) weeks.unshift(thisWeek);
        weeks = [...new Set(weeks)].sort().reverse();
        weeks.forEach(function(wk) {
            var div = document.createElement('div');
            div.className = 'week-list-item ' + (wk === currentViewWeekKey ? 'active' : '');
            var label = getWeekRangeString(wk);
            if (wk === thisWeek) label += " (æœ¬é€±)";
            div.onclick = function() {
                currentViewWeekKey = wk;
                closeWeekSelectModal();
                renderAll();
            };
            div.textContent = label;
            weekListContainer.appendChild(div);
        });
        weekSelectModal.classList.add('open');
    }
    function closeWeekSelectModal() {
        weekSelectModal.classList.remove('open');
    }

    function highlightTodayColumn() {
        setTimeout(() => {
            const todayCols = document.querySelectorAll('.today-col');
            if(todayCols.length > 0) {
                const target = todayCols[0];
                target.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }, 300);
    }

    // -----------------------------------------------------------
    // 3. ç¶å®š Window å…¨åŸŸè®Šæ•¸ & å•Ÿå‹•
    // -----------------------------------------------------------
    window.handleQuickAdd = handleQuickAdd;
    window.openWeekSelectModal = openWeekSelectModal;
    window.closeWeekSelectModal = closeWeekSelectModal;
    
    // åˆå§‹åŒ–åŸ·è¡Œ
    initApp();
  </script>
</body>
</html>
