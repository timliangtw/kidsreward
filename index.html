<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å®¶ç”¨é»æ•¸ä»»å‹™æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f5f7; }

    /* è®“æ•´é«”å­—å¤§ä¸€é»ï¼Œé©åˆå°å­©æ‰‹æŒ‡ + è¦–åŠ› */
    body { font-size: 18px; }

    .app {
      max-width: 480px;
      margin: 16px auto;
      background: white;
      border-radius: 24px;
      box-shadow: 0 0 12px rgba(0,0,0,0.12);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 88vh;
      position: relative; /* For Modal positioning context */
    }

    /* ç”·å­© / å¥³å­© ä¸»é¡Œè‰² */
    .app.boy header {
      background: linear-gradient(135deg,#4f8cf7,#7ab8ff);
    }
    .app.girl header {
      background: linear-gradient(135deg,#ff7eb3,#ff9a9e);
    }

    header {
      color: white;
      padding: 18px 18px 14px;
    }
    .header-top { display:flex; justify-content:space-between; align-items:center; }
    .kid-main { display:flex; align-items:center; gap:10px; }
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #ffdd66;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 700;
      font-size: 22px;
      color: #333;
    }
    .kid-name { font-size: 22px; font-weight: 700; }
    .kid-sub { font-size: 14px; opacity: 0.95; }
    .switch-btn {
      border: none;
      background: rgba(255,255,255,0.25);
      color: white;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
    }
    .header-bottom {
      margin-top: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 8px;
    }
    .date-chip {
      background: rgba(255,255,255,0.2);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
      font-size: 14px;
    }
    .total-points {
      font-size: 26px;
      font-weight: 800;
      display:flex;
      align-items:center;
      gap: 6px;
      white-space: nowrap;
    }

    main {
      padding: 10px 16px 12px;
      flex: 1;
      overflow-y: auto;
    }
    h2 {
      font-size: 18px;
      margin: 10px 0 6px;
    }
    .card {
      background:#fff;
      border-radius:16px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }

    /* Firebase åŒæ­¥ç‹€æ…‹åˆ— */
    .sync-bar {
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      gap: 6px;
      margin-bottom: 10px;
    }
    .sync-bar.synced {
      background:#e8f5e9;
      color:#2e7d32;
    }
    .sync-bar.syncing {
      background:#fff8e1;
      color:#f57f17;
    }
    .sync-bar.error {
      background:#ffebee;
      color:#c62828;
    }

    /* é€±ä»»å‹™è¡¨ */
    .week-wrapper {
      overflow-x:auto;
      padding-bottom: 6px;
      position: relative;
      scroll-behavior:smooth;
    }
    .week-table {
      min-width: 640px; 
      border-radius: 16px;
      background:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,0.04);
      padding:10px;
    }
    .week-header,
    .task-row,
    .day-summary-row {
      display:flex;
      align-items:center;
      gap: 6px;
      font-size: 14px;
    }
    .week-header {
      font-weight:700;
      margin-bottom:6px;
    }
    
    .task-name-header,
    .task-name,
    .task-name-summary {
      flex:0 0 120px;
      min-width:120px;
      font-size:14px;
      font-weight:600;
      position: sticky;
      left: 0;
      background: #fff; 
      z-index: 10;
      box-shadow: 2px 0 5px rgba(0,0,0,0.05); 
      margin-right: -1px;
      align-self: stretch; 
      display: flex;
      align-items: center;
    }

    .day-header,
    .day-cell,
    .day-summary-cell {
      flex:1;
      text-align:center;
    }
    .day-cell input {
      width: 30px;
      height: 30px;
      cursor:pointer;
    }
    .task-row {
      margin-bottom:6px;
    }
    .day-summary-row {
      margin-top:4px;
      padding-top:4px;
      border-top:1px dashed #eee;
      font-size:13px;
      color:#555;
    }
    .day-summary-cell-positive { color:#2e7d32; font-weight:600; }
    .day-summary-cell-negative { color:#c62828; font-weight:600; }
    .today-col { background:#e3f2fd; border-radius:8px; }

    /* History */
    .history-item { display:flex; justify-content:space-between; margin-bottom:10px; font-size: 15px; }
    .history-main { max-width: 70%; }
    .history-date { font-size: 13px; color:#888; }
    .history-delta { font-weight: 600; font-size: 16px; }
    .history-delete-btn {
      margin-top: 4px;
      padding: 2px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fafafa;
      cursor: pointer;
    }

    /* Settings */
    .settings-group { margin-bottom: 16px; }
    .settings-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #eee;
      font-size: 15px;
    }
    .settings-label { font-weight: 600; }
    .settings-sub { font-size: 13px; color:#777; margin-top:2px; }
    .settings-btn {
      border-radius:999px;
      border:1px solid #ddd;
      background:#fafafa;
      padding:6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    /* Quick points */
    .quick-row { display:flex; gap:10px; margin-top:6px; }
    .pill-btn {
      flex:1;
      border-radius:999px;
      border:none;
      /* æ”¹å¤§æŒ‰éˆ• */
      padding:14px 8px; 
      font-size:16px;
      font-weight: 700;
      cursor:pointer;
    }
    .pill-plus { background:#e3f2fd; color:#1565c0; }
    .pill-minus { background:#ffebee; color:#c62828; }
    .small-label { font-size: 13px; color:#777; margin-top:6px; }
    .small-input {
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #ddd;
      margin-top:4px;
      font-size: 15px;
    }

    /* Tabs content */
    .tab-page { display:none; }
    .tab-page.active { display:block; }

    /* Bottom nav */
    nav {
      display:flex;
      justify-content:space-around;
      border-top:1px solid #ddd;
      background:#fff;
    }
    .nav-item {
      flex:1;
      text-align:center;
      padding:10px 0 12px;
      font-size: 14px;
      cursor:pointer;
      color:#777;
    }
    .nav-icon { display:block; font-size: 20px; margin-bottom:2px; }
    .nav-item.active { color:#3366cc; font-weight:600; }

    /* Toast Message */
    #toast-msg {
      pointer-events: none;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9990;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: white;
      width: 90%;
      max-width: 400px;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .modal h3 { margin-bottom: 16px; font-size: 20px; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px; color: #555; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .btn-cancel { background: #f5f5f5; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 15px; }
    .btn-save { background: #4f8cf7; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; }
    
    .radio-group { display: flex; gap: 16px; }
    .radio-label { display: flex; align-items: center; gap: 6px; font-size: 15px; cursor: pointer; }
  </style>
</head>
<body>
  <!-- é è¨­å…ˆç”¨ boy ä¸»é¡Œï¼Œä¹‹å¾Œå¯ç”±ç¨‹å¼åˆ‡æ› girl -->
  <div class="app boy">
    <header>
      <div class="header-top">
        <div class="kid-main">
          <div class="avatar">L</div>
          <div>
            <div class="kid-name">Leo</div>
            <div class="kid-sub">ä»Šå¤©ä¸€èµ·åŠ æ²¹ ğŸ’ª</div>
          </div>
        </div>
        <button class="switch-btn" type="button">åˆ‡æ›å°å­© â–¾</button>
      </div>
      <div class="header-bottom">
        <div class="date-chip" id="date-chip">æœ¬é€±ï¼š11 / 18 ï½ 11 / 24</div>
        <div class="total-points" id="total-points">
          <span>â­</span>
          <span>32 é»</span>
        </div>
      </div>
    </header>

    <main>
      <!-- Firebase åŒæ­¥ç‹€æ…‹åˆ— -->
      <div class="sync-bar synced" id="sync-bar" data-status="synced">
        âœ… å·²å„²å­˜æ–¼æœ¬æ©Ÿ (LocalStorage)
      </div>

      <!-- æœ¬é€± Tab -->
      <section class="tab-page active" data-tab="today">
        <h2>æœ¬é€±ä»»å‹™è¡¨</h2>
        <div class="week-wrapper">
        <div class="week-table" id="week-table"></div>
        </div>

        <h2>å¿«é€ŸåŠ  / æ‰£é»ï¼ˆçˆ¸åª½ï¼‰</h2>
        <div class="card" id="quick-points-card">
          <div class="small-label">èª¿æ•´ä»Šå¤©çš„é»æ•¸ï¼ˆä¹Ÿæœƒå½±éŸ¿ç¸½é»æ•¸ï¼‰</div>
          <div class="quick-row">
            <button class="pill-btn pill-plus" type="button">+1 é»</button>
            <button class="pill-btn pill-minus" type="button">-1 é»</button>
          </div>
          <div class="small-label">å‚™è¨»ï¼ˆé¸å¡«ï¼Œè¨˜éŒ„åŸå› ï¼‰</div>
          <input class="small-input" id="quick-note-input" placeholder="ä¾‹ï¼šä»Šå¤©ä¸»å‹•å¹«å¿™æ”¶ç©å…· +1 é»" />
        </div>
      </section>

      <!-- å…Œæ› Tab -->
      <section class="tab-page" data-tab="rewards">
        <h2>é»æ•¸å…Œæ›</h2>
        <div class="card">
          <div style="font-size:16px; margin-bottom:4px;">
            ç›®å‰å°å­©ï¼š<strong><span id="redeem-kid-name">Leo</span></strong>
          </div>
          <div style="font-size:15px;">
            å¯ç”¨ç¸½é»æ•¸ï¼š<span id="redeem-kid-points" style="font-size:22px;font-weight:800;">32</span> é»
          </div>
          <div style="font-size:13px;color:#777;margin-top:6px;">
            ï¼ˆé€™è£¡é¡¯ç¤ºçš„æ˜¯ç›®å‰é€™ä½å°å­©çš„ç¸½é»æ•¸ï¼Œå…Œæ›æ™‚æœƒå¾é€™è£¡æ‰£é™¤ï¼‰
          </div>
        </div>

        <h2>è¼¸å…¥å…Œæ›å…§å®¹</h2>
        <div class="card">
          <div class="small-label">å…Œæ›åç¨±</div>
          <input id="redeem-name-input" class="small-input" placeholder="ä¾‹ï¼šå»çœ‹ç«è»Šã€æ›ä¸€å€‹ç©å…·ã€å¤šçœ‹ 10 åˆ†é˜å¡é€šâ€¦â€¦" />

          <div class="small-label">æ‰£é™¤é»æ•¸</div>
          <input id="redeem-points-input" class="small-input" placeholder="ä¾‹ï¼š20" />

          <div class="small-label">å‚™è¨»ï¼ˆé¸å¡«ï¼Œèªªæ˜æˆ–é™åˆ¶æ¢ä»¶ï¼‰</div>
          <input id="redeem-note-input" class="small-input" placeholder="ä¾‹ï¼šå‡æ—¥é™å®šã€éœ€è¦çˆ¸åª½å…ˆåŒæ„ï¼ˆç¤ºæ„ï¼‰" />

          <div class="quick-row" style="margin-top:10px;">
            <button id="redeem-confirm-btn" class="pill-btn pill-minus" type="button">ç¢ºèªå…Œæ›</button>
          </div>
        </div>

        <h2>æœ€è¿‘ä¸€æ¬¡å…Œæ›ï¼ˆç¤ºæ„ï¼‰</h2>
        <div class="card">
          <div class="history-item">
            <div class="history-main">
              <div>-20 é»ï¼šå»çœ‹ç«è»Š</div>
              <div class="history-date">2025 / 11 / 23 ä¸‹åˆ Â· ç”±çˆ¸åª½ç¢ºèª</div>
            </div>
            <div class="history-delta" style="color:#c62828;">-20</div>
          </div>
          <div style="font-size:13px;color:#777;">ï¼ˆæ­·å²ç´€éŒ„å€ï¼‰</div>
        </div>
      </section>

      <!-- ç´€éŒ„ Tab -->
      <section class="tab-page" data-tab="history">
        <h2>è¿‘æœŸé»æ•¸ç´€éŒ„</h2>
        <div class="card" id="points-history-card">
          <!-- ç´€éŒ„ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
        </div>
      </section>

      <!-- è¨­å®š Tab -->
      <section class="tab-page" data-tab="settings">
        <h2>å°å­©ç®¡ç†</h2>
        <div class="card settings-group" id="settings-kid-list">
          <!-- å°å­©åˆ—è¡¨ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
        </div>

        <h2>ä»»å‹™ç®¡ç†</h2>
        <div class="card settings-group">
          <!-- é€™è£¡æ”¹æˆå‹•æ…‹ç”Ÿæˆï¼Œæ–¹ä¾¿æ–°å¢/åˆªé™¤ -->
          <div id="settings-task-list"></div>

          <!-- æ–°å¢ä»»å‹™å€å¡Š -->
          <div class="settings-item">
            <div style="width: 100%; padding-right: 10px;">
              <div class="settings-label">æ–°å¢ä»»å‹™</div>
              <input id="settings-new-task-input" class="small-input" placeholder="ä¾‹ï¼šä¸»å‹•å¹«å¿™åšå®¶äº‹ã€é–±è®€ 10 åˆ†é˜â€¦â€¦" />
              <div class="settings-sub">ï¼ˆæ–°å¢å¾Œæœƒå³æ™‚é¡¯ç¤ºåœ¨æœ¬é€±ä»»å‹™è¡¨ï¼‰</div>
            </div>
            <button id="settings-new-task-btn" class="settings-btn" type="button">æ–°å¢</button>
          </div>
        </div>

        <h2>æ¯æ—¥é»æ•¸è¦å‰‡</h2>
        <div class="card settings-group">
          <div class="small-label">è¨­å®šã€Œä¸€å¤©å®Œæˆå¹¾é …ä»»å‹™ã€æœƒåŠ å¤šå°‘é»ï¼ˆä¸æ˜¯æ¯å€‹ä»»å‹™éƒ½æœ‰è‡ªå·±çš„é»æ•¸ï¼‰ã€‚</div>
          <div class="settings-item">
            <div>
              <div class="settings-label">è¦å‰‡ 1</div>
              <div class="settings-sub">å®Œæˆ â‰§ 1 é …ä»»å‹™ â†’ ç•¶å¤©åŠ  1 é»</div>
            </div>
            <button class="settings-btn" type="button">ç·¨è¼¯</button>
          </div>
          <div class="settings-item">
            <div>
              <div class="settings-label">è¦å‰‡ 2</div>
              <div class="settings-sub">å®Œæˆ â‰§ 3 é …ä»»å‹™ â†’ ç•¶å¤©åŠ  2 é»</div>
            </div>
            <button class="settings-btn" type="button">ç·¨è¼¯</button>
          </div>
          <div class="settings-item">
            <div>
              <div class="settings-label">æ–°å¢è¦å‰‡</div>
              <div style="display:flex; gap:6px; align-items:center; margin-top:4px;">
                <span style="font-size:14px;">å®Œæˆ â‰§</span>
                <input class="small-input" style="max-width:70px;" placeholder="å¹¾é …" />
                <span style="font-size:14px;">é … â†’ åŠ </span>
                <input class="small-input" style="max-width:70px;" placeholder="å¹¾é»" />
                <span style="font-size:14px;">é»</span>
              </div>
              <div class="settings-sub">ï¼ˆä¹‹å¾Œå¯¦ä½œæ™‚ï¼šé€™äº›è¦å‰‡æœƒç”¨ä¾†è¨ˆç®—æœ¬é€±ä»»å‹™è¡¨ä¸Šæ¯ä¸€å¤©çš„ã€Œæœ¬æ—¥å°è¨ˆã€ã€‚ï¼‰</div>
            </div>
            <button class="settings-btn" type="button">æ–°å¢</button>
          </div>
        </div>

        <!-- Phase 4 æ–°å¢ï¼šé‡ç½®è³‡æ–™æŒ‰éˆ• -->
        <h2>è³‡æ–™é¸é …</h2>
        <div class="card settings-group">
          <div class="settings-item">
            <div>
              <div class="settings-label" style="color:#c62828;">é‡ç½®æ‰€æœ‰è³‡æ–™</div>
              <div class="settings-sub">æ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Œå›åˆ°åˆå§‹ç‹€æ…‹ã€‚</div>
            </div>
            <button id="reset-data-btn" class="settings-btn" type="button" style="color:#c62828;border-color:#ffcdd2;">é‡ç½®</button>
          </div>
        </div>
      </section>
    </main>

    <nav>
      <div class="nav-item active" data-tab-target="today">
        <span class="nav-icon">ğŸ“…</span>
        æœ¬é€±
      </div>
      <div class="nav-item" data-tab-target="rewards">
        <span class="nav-icon">ğŸ</span>
        å…Œæ›
      </div>
      <div class="nav-item" data-tab-target="history">
        <span class="nav-icon">ğŸ“œ</span>
        ç´€éŒ„
      </div>
      <div class="nav-item" data-tab-target="settings">
        <span class="nav-icon">âš™ï¸</span>
        è¨­å®š
      </div>
    </nav>

    <!-- ç·¨è¼¯å°å­©çš„å½ˆçª— (Modal) -->
    <div class="modal-overlay" id="edit-kid-modal">
      <div class="modal">
        <h3>ç·¨è¼¯å°å­©è³‡æ–™</h3>
        <input type="hidden" id="edit-kid-key" />
        
        <div class="form-group">
          <label>é¡¯ç¤ºåç¨± (Name)</label>
          <input id="edit-kid-name" class="small-input" />
        </div>

        <div class="form-group">
          <label>ä¸»é¡Œé¡è‰²</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="edit-kid-theme" value="boy"> è—è‰² (Boy)
            </label>
            <label class="radio-label">
              <input type="radio" name="edit-kid-theme" value="girl"> ç²‰è‰² (Girl)
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>ç›®å‰ç¸½é»æ•¸ (å¯ç›´æ¥ä¿®æ”¹)</label>
          <input id="edit-kid-points" type="number" class="small-input" />
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" id="btn-cancel-edit">å–æ¶ˆ</button>
          <button class="btn-save" id="btn-save-edit">å„²å­˜</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ===== UI Helper: Toast =====
    function showToast(msg) {
      var toast = document.getElementById('toast-msg');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-msg';
        toast.style.position = 'fixed';
        toast.style.bottom = '80px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = 'rgba(0,0,0,0.8)';
        toast.style.color = '#fff';
        toast.style.padding = '10px 20px';
        toast.style.borderRadius = '20px';
        toast.style.zIndex = '9999';
        toast.style.fontSize = '14px';
        toast.style.transition = 'opacity 0.5s';
        toast.style.opacity = '0';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.style.opacity = '1';
      setTimeout(function() {
        toast.style.opacity = '0';
      }, 2000);
    }

    // ===== ç°¡å–®é ç±¤åˆ‡æ› =====
    var navItems = document.querySelectorAll('.nav-item');
    var pages = document.querySelectorAll('.tab-page');

    navItems.forEach(function(item) {
      item.addEventListener('click', function() {
        var target = item.getAttribute('data-tab-target');

        navItems.forEach(function(n) { n.classList.remove('active'); });
        item.classList.add('active');

        pages.forEach(function(page) {
          if (page.getAttribute('data-tab') === target) {
            page.classList.add('active');
          } else {
            page.classList.remove('active');
          }
        });
      });
    });

    // ===== Phase 4: LocalStorage è¨­å®š =====
    var STORAGE_KEY = 'family_points_data_v1';

    // ===== æ¯æ—¥è¦å‰‡ State =====
    var rulesState = [
      { threshold: 3, points: 2 }, 
      { threshold: 1, points: 1 }  
    ];

    // ===== ç‹€æ…‹å®šç¾© (é è¨­å€¼) =====
    var defaultKidsState = {
      leo: {
        key: 'leo',
        displayName: 'Leo',
        avatar: 'L',
        slogan: 'ä»Šå¤©ä¸€èµ·åŠ æ²¹ ğŸ’ª',
        theme: 'boy',
        totalPoints: 0,
        dailySummary: [0,0,0,0,0,0,0], 
        weeklyChecks: [[],[],[],[],[],[],[]], 
        history: []
      },
      natasha: {
        key: 'natasha',
        displayName: 'Natasha',
        avatar: 'N',
        slogan: 'ä¸€èµ·é–‹å¿ƒç©è€ ğŸŒˆ',
        theme: 'girl',
        totalPoints: 0,
        dailySummary: [0,0,0,0,0,0,0],
        weeklyChecks: [[],[],[],[],[],[],[]],
        history: []
      }
    };

    var defaultTasksState = [
      { id: 'dress', name: 'è‡ªå·±ç©¿å¥½è¡£æœ' },
      { id: 'hw',    name: 'å¯«å®Œå›å®¶ä½œæ¥­' },
      { id: 'toys',  name: 'ç¡å‰æ”¶ç©å…·' }
    ];

    // å¯¦éš›ä½¿ç”¨çš„ State è®Šæ•¸
    var kidsState = JSON.parse(JSON.stringify(defaultKidsState));
    var tasksState = JSON.parse(JSON.stringify(defaultTasksState));
    var currentKid = 'leo';

    // ===== å„²å­˜èˆ‡è®€å– =====
    function saveData() {
      var data = {
        kids: kidsState,
        tasks: tasksState,
        rules: rulesState
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadData() {
      var raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          var data = JSON.parse(raw);
          if (data.kids) kidsState = data.kids;
          if (data.tasks) tasksState = data.tasks;
          if (data.rules) rulesState = data.rules;
        } catch (e) {
          console.error('è®€å–å­˜æª”å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼', e);
        }
      }
    }

    function performReset() {
      localStorage.removeItem(STORAGE_KEY);
      kidsState = JSON.parse(JSON.stringify(defaultKidsState));
      tasksState = JSON.parse(JSON.stringify(defaultTasksState));
      currentKid = 'leo';
      
      renderCurrentKid();
      renderWeekTable();
      renderHistoryList();
      renderSettingsTaskList();
      renderSettingsKidList(); // Refresh kid list
      
      showToast('è³‡æ–™å·²é‡ç½®æˆé è¨­å€¼');
    }

    // ===== DOM åƒç…§ =====
    var appEl = document.querySelector('.app');
    var switchBtn = document.querySelector('.switch-btn');
    var kidNameEl = document.querySelector('.kid-name');
    var avatarEl = document.querySelector('.avatar');
    var kidSubEl = document.querySelector('.kid-sub');
    var totalPointsEl = document.getElementById('total-points');

    var redeemKidNameEl = document.getElementById('redeem-kid-name');
    var redeemKidPointsEl = document.getElementById('redeem-kid-points');
    var redeemNameInput = document.getElementById('redeem-name-input');
    var redeemPointsInput = document.getElementById('redeem-points-input');
    var redeemNoteInput = document.getElementById('redeem-note-input');
    var redeemConfirmBtn = document.getElementById('redeem-confirm-btn');

    var quickPlusBtn = document.querySelector('#quick-points-card .pill-plus');
    var quickMinusBtn = document.querySelector('#quick-points-card .pill-minus');
    var quickNoteInput = document.getElementById('quick-note-input');

    var historyCard = document.getElementById('points-history-card');

    var settingsTaskListEl = document.getElementById('settings-task-list');
    var settingsNewTaskInput = document.getElementById('settings-new-task-input');
    var settingsNewTaskBtn = document.getElementById('settings-new-task-btn');
    
    var settingsKidListEl = document.getElementById('settings-kid-list');

    // Modal Elements
    var editKidModal = document.getElementById('edit-kid-modal');
    var editKidKeyInput = document.getElementById('edit-kid-key');
    var editKidNameInput = document.getElementById('edit-kid-name');
    var editKidPointsInput = document.getElementById('edit-kid-points');
    var btnCancelEdit = document.getElementById('btn-cancel-edit');
    var btnSaveEdit = document.getElementById('btn-save-edit');

    // Reset Btn
    var resetDataBtn = document.getElementById('reset-data-btn');
    if (resetDataBtn) {
      resetDataBtn.addEventListener('click', function() {
        if (resetDataBtn.textContent !== 'ç¢ºå®šé‡ç½®ï¼Ÿ') {
          resetDataBtn.textContent = 'ç¢ºå®šé‡ç½®ï¼Ÿ';
          resetDataBtn.style.backgroundColor = '#ffebee'; 
          setTimeout(function() {
            if (resetDataBtn.parentElement) { 
              resetDataBtn.textContent = 'é‡ç½®';
              resetDataBtn.style.backgroundColor = '';
            }
          }, 3000);
        } else {
          performReset();
          resetDataBtn.textContent = 'é‡ç½®';
          resetDataBtn.style.backgroundColor = '';
        }
      });
    }

    // ===== å·¥å…·å‡½å¼ =====
    function formatDailySummary(value) {
      var sign = value >= 0 ? '+' : '';
      return sign + value;
    }

    function getTodayColumnIndex() {
      var today = new Date();
      var jsDay = today.getDay(); 
      switch (jsDay) {
        case 0: return 6; 
        case 1: return 0; 
        case 2: return 1; 
        case 3: return 2; 
        case 4: return 3; 
        case 5: return 4; 
        case 6: return 5; 
        default: return 0;
      }
    }

    // ===== è¨ˆç®—æ¯æ—¥é»æ•¸ =====
    function calculateDailyTotal(kid, dayIndex) {
      if (!kid.weeklyChecks) kid.weeklyChecks = [[],[],[],[],[],[],[]];
      var checkedCount = kid.weeklyChecks[dayIndex] ? kid.weeklyChecks[dayIndex].length : 0;
      var rulePoints = 0;
      
      var maxPoints = 0;
      var matched = false;
      rulesState.forEach(function(rule) {
        if (checkedCount >= rule.threshold) {
          if (rule.points > maxPoints) {
            maxPoints = rule.points;
            matched = true;
          }
        }
      });
      if (matched) rulePoints = maxPoints;

      var manualPoints = kid.dailySummary[dayIndex] || 0;
      return rulePoints + manualPoints;
    }

    // ===== æ¸²æŸ“ã€Œæœ¬é€±ä»»å‹™è¡¨ã€ =====
    function renderWeekTable() {
      var container = document.getElementById('week-table');
      if (!container) return;

      container.innerHTML = '';
      var weekDays = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];

      // Header
      var headerRow = document.createElement('div');
      headerRow.className = 'week-header';
      var taskHeader = document.createElement('div');
      taskHeader.className = 'task-name-header';
      taskHeader.textContent = 'ä»»å‹™';
      headerRow.appendChild(taskHeader);

      weekDays.forEach(function(label, index) {
        var cell = document.createElement('div');
        cell.className = 'day-header';
        cell.setAttribute('data-day-index', String(index));
        cell.textContent = label;
        headerRow.appendChild(cell);
      });
      container.appendChild(headerRow);

      // Summary Row
      var summaryRow = document.createElement('div');
      summaryRow.className = 'day-summary-row';
      var summaryName = document.createElement('div');
      summaryName.className = 'task-name-summary';
      summaryName.textContent = 'æœ¬æ—¥å°è¨ˆ';
      summaryRow.appendChild(summaryName);

      var kid = kidsState[currentKid];
      
      for (var i = 0; i < 7; i++) {
        var total = calculateDailyTotal(kid, i);
        var cell = document.createElement('div');
        cell.className = 'day-summary-cell';
        cell.setAttribute('data-day-index', String(i));
        cell.textContent = formatDailySummary(total);
        if (total > 0) cell.classList.add('day-summary-cell-positive');
        else if (total < 0) cell.classList.add('day-summary-cell-negative');
        summaryRow.appendChild(cell);
      }
      container.appendChild(summaryRow);

      // Tasks Rows
      tasksState.forEach(function(task) {
        var row = document.createElement('div');
        row.className = 'task-row';

        var nameDiv = document.createElement('div');
        nameDiv.className = 'task-name';
        nameDiv.textContent = task.name;
        row.appendChild(nameDiv);

        [0, 1, 2, 3, 4, 5, 6].forEach(function(i) {
          var label = document.createElement('label');
          label.className = 'day-cell';
          label.setAttribute('data-day-index', String(i));
          
          var checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          
          if (kid.weeklyChecks && kid.weeklyChecks[i] && kid.weeklyChecks[i].includes(task.id)) {
            checkbox.checked = true;
          }

          checkbox.addEventListener('change', function(e) {
            handleTaskToggle(i, task.id, e.target.checked);
          });

          label.appendChild(checkbox);
          row.appendChild(label);
        });
        container.appendChild(row);
      });

      highlightTodayColumn();
    }

    // ===== ä»»å‹™æ‰“å‹¾é‚è¼¯ =====
    function handleTaskToggle(dayIndex, taskId, isChecked) {
      var kid = kidsState[currentKid];
      if (!kid) return;

      var oldDailyTotal = calculateDailyTotal(kid, dayIndex);

      if (!kid.weeklyChecks) kid.weeklyChecks = [[],[],[],[],[],[],[]];
      var dayChecks = kid.weeklyChecks[dayIndex];
      
      if (isChecked) {
        if (!dayChecks.includes(taskId)) {
          dayChecks.push(taskId);
        }
      } else {
        var idx = dayChecks.indexOf(taskId);
        if (idx > -1) {
          dayChecks.splice(idx, 1);
        }
      }

      var newDailyTotal = calculateDailyTotal(kid, dayIndex);
      var diff = newDailyTotal - oldDailyTotal;
      if (diff !== 0) {
        kid.totalPoints += diff;
        if (kid.totalPoints < 0) kid.totalPoints = 0;
      }

      saveData(); 
      renderWeekTable();
      renderCurrentKid();
    }

    // ===== æ¸²æŸ“ã€Œè¨­å®šé é¢ï¼šå°å­©åˆ—è¡¨ã€ (æ–°å¢) =====
    function renderSettingsKidList() {
      if (!settingsKidListEl) return;
      settingsKidListEl.innerHTML = '';

      Object.keys(kidsState).forEach(function(key) {
        var kid = kidsState[key];
        var item = document.createElement('div');
        item.className = 'settings-item';

        var infoDiv = document.createElement('div');
        var nameDiv = document.createElement('div');
        nameDiv.className = 'settings-label';
        nameDiv.textContent = kid.displayName;
        
        var subDiv = document.createElement('div');
        subDiv.className = 'settings-sub';
        var themeName = kid.theme === 'boy' ? 'è—è‰²' : 'ç²‰è‰²';
        subDiv.textContent = 'ä»£è¡¨é¡è‰²ï¼š' + themeName + ' Â· ç¸½é»æ•¸ ' + kid.totalPoints;

        infoDiv.appendChild(nameDiv);
        infoDiv.appendChild(subDiv);

        var btn = document.createElement('button');
        btn.className = 'settings-btn';
        btn.textContent = 'ç·¨è¼¯';
        btn.type = 'button';
        btn.addEventListener('click', function() {
          openEditKidModal(key);
        });

        item.appendChild(infoDiv);
        item.appendChild(btn);
        settingsKidListEl.appendChild(item);
      });
    }

    // ===== ç·¨è¼¯å°å­© Modal é‚è¼¯ =====
    function openEditKidModal(key) {
      var kid = kidsState[key];
      if (!kid) return;

      editKidKeyInput.value = key;
      editKidNameInput.value = kid.displayName;
      editKidPointsInput.value = kid.totalPoints;

      // è¨­å®š Radio Button
      var radios = document.getElementsByName('edit-kid-theme');
      for(var i=0; i<radios.length; i++) {
        if (radios[i].value === kid.theme) {
          radios[i].checked = true;
        }
      }

      editKidModal.classList.add('open');
    }

    function closeEditKidModal() {
      editKidModal.classList.remove('open');
    }

    function saveKidEdit() {
      var key = editKidKeyInput.value;
      var kid = kidsState[key];
      if (!kid) return;

      var newName = editKidNameInput.value.trim();
      var newPointsStr = editKidPointsInput.value;
      var newPoints = parseInt(newPointsStr, 10);

      if (!newName) {
        showToast('è«‹è¼¸å…¥åå­—');
        return;
      }
      if (isNaN(newPoints) || newPoints < 0) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„é»æ•¸');
        return;
      }

      var newTheme = 'boy';
      var radios = document.getElementsByName('edit-kid-theme');
      for(var i=0; i<radios.length; i++) {
        if (radios[i].checked) {
          newTheme = radios[i].value;
          break;
        }
      }

      // æ›´æ–° State
      kid.displayName = newName;
      kid.totalPoints = newPoints;
      kid.theme = newTheme;

      saveData();
      
      // é‡æ–°æ¸²æŸ“ç›¸é—œä»‹é¢
      renderSettingsKidList();
      renderCurrentKid(); // å¦‚æœå‰›å¥½æ˜¯ç•¶å‰å°å­©ï¼Œæ›´æ–° Header
      closeEditKidModal();
      showToast('å„²å­˜æˆåŠŸ');
    }

    if (btnCancelEdit) btnCancelEdit.addEventListener('click', closeEditKidModal);
    if (btnSaveEdit) btnSaveEdit.addEventListener('click', saveKidEdit);


    // ===== æ¸²æŸ“ã€Œè¨­å®šé é¢ï¼šä»»å‹™åˆ—è¡¨ã€ =====
    function renderSettingsTaskList() {
      if (!settingsTaskListEl) return;
      settingsTaskListEl.innerHTML = ''; 

      tasksState.forEach(function(task) {
        var item = document.createElement('div');
        item.className = 'settings-item';

        var infoDiv = document.createElement('div');
        var nameDiv = document.createElement('div');
        nameDiv.className = 'settings-label';
        nameDiv.textContent = task.name;
        
        var subDiv = document.createElement('div');
        subDiv.className = 'settings-sub';
        subDiv.textContent = 'é¡¯ç¤ºåœ¨æœ¬é€±ä»»å‹™è¡¨';

        infoDiv.appendChild(nameDiv);
        infoDiv.appendChild(subDiv);

        var btn = document.createElement('button');
        btn.className = 'settings-btn';
        btn.textContent = 'åˆªé™¤';
        btn.type = 'button';
        
        btn.addEventListener('click', function() {
          if (btn.textContent !== 'ç¢ºå®šï¼Ÿ') {
             btn.textContent = 'ç¢ºå®šï¼Ÿ';
             btn.style.color = '#c62828';
             setTimeout(function(){ 
               if(btn.parentElement) { 
                 btn.textContent = 'åˆªé™¤'; 
                 btn.style.color = '';
               }
             }, 3000);
           } else {
             handleDeleteTask(task.id);
           }
        });

        item.appendChild(infoDiv);
        item.appendChild(btn);
        settingsTaskListEl.appendChild(item);
      });
    }

    function handleAddTask() {
      if (!settingsNewTaskInput) return;
      var val = settingsNewTaskInput.value.trim();
      if (!val) {
        showToast('è«‹è¼¸å…¥ä»»å‹™åç¨±');
        return;
      }
      var newTask = {
        id: 't_' + Date.now(),
        name: val
      };
      tasksState.push(newTask);
      saveData(); 
      renderWeekTable();
      renderSettingsTaskList();
      settingsNewTaskInput.value = '';
      showToast('ä»»å‹™å·²æ–°å¢');
    }

    if (settingsNewTaskBtn) settingsNewTaskBtn.addEventListener('click', handleAddTask);

    function handleDeleteTask(taskId) {
      tasksState = tasksState.filter(function(t) { return t.id !== taskId; });
      saveData(); 
      renderWeekTable();
      renderSettingsTaskList();
      showToast('ä»»å‹™å·²åˆªé™¤');
    }

    // ===== å°å­©åˆ‡æ› & UI æ›´æ–° =====
    function renderCurrentKid() {
      var kid = kidsState[currentKid];
      if (!kid) return;

      kidNameEl.textContent = kid.displayName;
      avatarEl.textContent = kid.avatar; // é€™è£¡åªç”¨ç¬¬ä¸€å€‹å­—ï¼Œå¯å„ªåŒ–
      // å„ªåŒ–ï¼šAvatar é¡¯ç¤ºåå­—ç¬¬ä¸€å€‹å­—
      var firstChar = kid.displayName.charAt(0).toUpperCase();
      avatarEl.textContent = firstChar; 

      kidSubEl.textContent = kid.slogan;

      appEl.classList.toggle('boy', kid.theme === 'boy');
      appEl.classList.toggle('girl', kid.theme === 'girl');

      if (totalPointsEl) {
        totalPointsEl.innerHTML = '<span>â­</span><span>' + kid.totalPoints + ' é»</span>';
      }
      if (redeemKidNameEl && redeemKidPointsEl) {
        redeemKidNameEl.textContent = kid.displayName;
        redeemKidPointsEl.textContent = kid.totalPoints;
      }
    }

    if (switchBtn) {
      switchBtn.addEventListener('click', function() {
        currentKid = currentKid === 'leo' ? 'natasha' : 'leo';
        renderCurrentKid();
        renderWeekTable();
        renderHistoryList();
      });
    }

    function highlightTodayColumn() {
      var colIndex = getTodayColumnIndex();
      var selector = '[data-day-index="' + colIndex + '"]';
      var weekTable = document.querySelector('.week-table');
      if (weekTable) {
        weekTable.querySelectorAll(selector).forEach(function(el) {
          el.classList.add('today-col');
        });
      }
      var wrapper = document.querySelector('.week-wrapper');
      var headerCell = document.querySelector('.week-header ' + selector);
      if (wrapper && headerCell) {
        var wrapperRect = wrapper.getBoundingClientRect();
        var cellRect = headerCell.getBoundingClientRect();
        var offset = cellRect.left - wrapperRect.left - (wrapperRect.width / 2) + (cellRect.width / 2);
        wrapper.scrollLeft = wrapper.scrollLeft + offset;
      }
    }

    // ===== æ‰‹å‹•æ›´æ–°æœ¬æ—¥å°è¨ˆ (å¿«é€ŸåŠ /æ‰£é») =====
    function updateManualSummary(delta) {
      var colIndex = getTodayColumnIndex();
      var kid = kidsState[currentKid];
      if (!kid) return;

      var oldTotal = calculateDailyTotal(kid, colIndex);
      kid.dailySummary[colIndex] = (kid.dailySummary[colIndex] || 0) + delta;
      var newTotal = calculateDailyTotal(kid, colIndex);
      var diff = newTotal - oldTotal;
      if (diff !== 0) {
        kid.totalPoints += diff;
        if (kid.totalPoints < 0) kid.totalPoints = 0;
      }
      
      saveData(); 
      renderWeekTable();
      renderCurrentKid();
    }

    function renderHistoryList() {
      if (!historyCard) return;
      historyCard.innerHTML = '';

      var kid = kidsState[currentKid];
      if (!kid || !kid.history || kid.history.length === 0) {
        var empty = document.createElement('div');
        empty.style.fontSize = '14px';
        empty.style.color = '#777';
        empty.textContent = 'ç›®å‰æ²’æœ‰ç´€éŒ„';
        historyCard.appendChild(empty);
        return;
      }

      kid.history.forEach(function(rec) {
        var item = document.createElement('div');
        item.className = 'history-item';
        item.setAttribute('data-history-id', rec.id);

        var main = document.createElement('div');
        main.className = 'history-main';

        var descDiv = document.createElement('div');
        var sign = rec.delta > 0 ? '+' : '';
        descDiv.textContent = sign + rec.delta + ' é»ï¼š' + rec.reason;

        var dateDiv = document.createElement('div');
        dateDiv.className = 'history-date';
        var kidName = kidsState[currentKid] ? kidsState[currentKid].displayName : '';
        dateDiv.textContent = rec.dateStr + ' Â· ' + kidName + ' Â· ' + rec.fromWhere;

        var actionsDiv = document.createElement('div');
        var delBtn = document.createElement('button');
        delBtn.className = 'history-delete-btn';
        delBtn.textContent = 'åˆªé™¤é€™ç­†ç´€éŒ„ï¼ˆä¸¦é‚„åŸé»æ•¸ï¼‰';
        delBtn.addEventListener('click', function() {
          handleDeleteHistory(rec.id);
        });
        actionsDiv.appendChild(delBtn);

        main.appendChild(descDiv);
        main.appendChild(dateDiv);
        main.appendChild(actionsDiv);

        var deltaDiv = document.createElement('div');
        deltaDiv.className = 'history-delta';
        var signDelta = rec.delta > 0 ? '+' : '';
        deltaDiv.textContent = signDelta + rec.delta;
        deltaDiv.style.color = rec.delta >= 0 ? '#4caf50' : '#c62828';

        item.appendChild(main);
        item.appendChild(deltaDiv);
        historyCard.appendChild(item);
      });
    }

    function handleDeleteHistory(id) {
      var kid = kidsState[currentKid];
      if (!kid || !kid.history) return;
      var idx = -1;
      for (var i = 0; i < kid.history.length; i++) {
        if (kid.history[i].id === id) {
          idx = i; break;
        }
      }
      if (idx === -1) return;
      var rec = kid.history[idx];
      kid.totalPoints -= rec.delta;
      if (kid.totalPoints < 0) kid.totalPoints = 0;
      kid.history.splice(idx, 1);
      
      saveData(); 
      renderCurrentKid();
      renderHistoryList();
      showToast('ç´€éŒ„å·²åˆªé™¤');
    }

    function appendHistoryItem(delta, reason, fromWhere) {
      var kid = kidsState[currentKid];
      if (!kid) return;
      if (!kid.history) kid.history = [];
      var now = new Date();
      var dateStr = now.getFullYear() + ' / ' + (now.getMonth()+1).toString().padStart(2,'0') + ' / ' + now.getDate().toString().padStart(2,'0') + ' ' + now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
      var rec = {
        id: 'h_' + Date.now() + '_' + Math.random().toString(16).slice(2),
        delta: delta,
        reason: reason,
        fromWhere: fromWhere,
        dateStr: dateStr
      };
      kid.history.unshift(rec);
      saveData(); 
      renderHistoryList();
    }

    function adjustPoints(delta) {
      updateManualSummary(delta);
      var note = quickNoteInput ? quickNoteInput.value.trim() : '';
      var reason = note ? note : (delta > 0 ? 'è‡¨æ™‚åŠ é»' : 'æ‰£é»');
      appendHistoryItem(delta, reason, 'å¿«é€ŸåŠ  / æ‰£é»');
      if (quickNoteInput) quickNoteInput.value = '';
      showToast(delta > 0 ? 'åŠ é»æˆåŠŸï¼' : 'å·²æ‰£é»');
    }

    if (quickPlusBtn) quickPlusBtn.addEventListener('click', function() { adjustPoints(1); });
    if (quickMinusBtn) quickMinusBtn.addEventListener('click', function() { adjustPoints(-1); });

    function handleRedeemConfirm() {
      var kid = kidsState[currentKid];
      if (!kid || !redeemPointsInput) return;
      var name = redeemNameInput ? redeemNameInput.value.trim() : '';
      var pts = parseInt(redeemPointsInput.value.trim(), 10);
      if (!pts || pts <= 0) {
        showToast('è«‹è¼¸å…¥æ­£ç¢ºçš„é»æ•¸');
        return;
      }
      if (kid.totalPoints < pts) {
        showToast('é»æ•¸ä¸è¶³ï¼');
        return;
      }
      kid.totalPoints -= pts;
      renderCurrentKid();
      var note = redeemNoteInput ? redeemNoteInput.value.trim() : '';
      var reason = 'å…Œæ›ï¼š' + (name || 'æœªå‘½åçå‹µ') + (note ? 'ï¼ˆ' + note + 'ï¼‰' : '');
      appendHistoryItem(-pts, reason, 'å…Œæ›'); 
      if (redeemNameInput) redeemNameInput.value = '';
      redeemPointsInput.value = '';
      if (redeemNoteInput) redeemNoteInput.value = '';
      showToast('å…Œæ›æˆåŠŸï¼');
    }

    if (redeemConfirmBtn) redeemConfirmBtn.addEventListener('click', handleRedeemConfirm);

    function init() {
      loadData(); 
      renderCurrentKid();
      renderWeekTable();
      renderHistoryList();
      renderSettingsTaskList();
      renderSettingsKidList(); // æ–°å¢
    }

    init();
  </script>
</body>
</html>
