<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>家用點數任務板 v6.11 (規則獨立化)</title>
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div class="app boy">
    <header>
      <div class="header-top">
        <div class="kid-main">
          <div class="avatar">
            L
            <div id="db-status" class="connection-dot" title="連線中..."></div>
          </div>
          <div class="kid-info-block">
            <div class="name-row">
              <div class="kid-name">Leo</div>
              <div id="save-badge" class="save-badge">✅ 已同步</div>
            </div>
            <div class="kid-sub">今天一起加油 💪</div>
          </div>
        </div>
        <button class="switch-btn" type="button">切換小孩 ▾</button>
      </div>
      <div class="header-bottom">
        <div class="date-chip" id="date-chip" onclick="openWeekSelectModal()">本週：-- / --</div>
        <div class="points-container">
          <div class="total-points" id="total-points">
            <span>⭐</span>
            <span>0 點</span>
          </div>
          <div class="weekly-points" id="weekly-points">
            本週：0 點
          </div>
        </div>
      </div>
    </header>

    <main>
      <section class="tab-page active" data-tab="today">
        <h2>任務表 <span id="viewing-week-label" style="font-size:14px; color:#666; font-weight:normal;">(本週)</span></h2>
        <div class="week-wrapper">
          <div class="week-table" id="week-table"></div>
        </div>

        <h2>快速加 / 扣點（爸媽）</h2>
        <div class="card" id="quick-points-card">
          <div class="small-label">調整今天的點數（也會影響總點數）</div>
          <div class="quick-row">
            <button class="pill-btn pill-plus" type="button" onclick="handleQuickAdd(1)">+1 點</button>
            <button class="pill-btn pill-minus" type="button" onclick="handleQuickAdd(-1)">-1 點</button>
          </div>
          <div class="small-label">備註（選填，記錄原因）</div>

          <!-- Smart Input Area -->
          <input class="small-input" id="quick-note-input" list="quick-note-list" placeholder="例：今天主動幫忙收玩具 +1 點" />
          <datalist id="quick-note-list"></datalist>
          <div id="quick-note-chips" class="chip-container"></div>
          <!-- End Smart Input -->

        </div>

        <h2>大量加 / 扣點</h2>
        <div class="card" id="bulk-points-card">
          <div class="small-label">輸入點數</div>
          <input id="bulk-points-input" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input"
            placeholder="輸入數字，例如 10, 50..." />

          <div class="small-label">備註（選填）</div>

          <!-- Smart Input Area -->
          <input id="bulk-note-input" class="small-input" list="bulk-note-list" placeholder="原因，例如：期末考滿分" />
          <datalist id="bulk-note-list"></datalist>
          <div id="bulk-note-chips" class="chip-container"></div>
          <!-- End Smart Input -->

          <div class="quick-row" style="margin-top:10px;">
            <button class="pill-btn pill-plus" type="button" onclick="handleBulkAction(1)">大量加點 (+)</button>
            <button class="pill-btn pill-minus" type="button" onclick="handleBulkAction(-1)">大量扣點 (-)</button>
          </div>
        </div>

      </section>

      <section class="tab-page" data-tab="rewards">
        <h2>點數兌換</h2>
        <div class="card">
          <div style="font-size:16px; margin-bottom:4px;">
            目前小孩：<strong><span id="redeem-kid-name">Leo</span></strong>
          </div>
          <div style="font-size:15px;">
            可用總點數：<span id="redeem-kid-points" style="font-size:22px;font-weight:800;">0</span> 點
          </div>
          <div style="font-size:13px;color:#777;margin-top:6px;">
            （這裡顯示的是目前這位小孩的總點數，兌換時會從這裡扣除）
          </div>
        </div>

        <h2>輸入兌換內容</h2>
        <div class="card">
          <div class="small-label">兌換名稱</div>
          <input id="redeem-name-input" class="small-input" placeholder="例：去看火車、換一個玩具..." />

          <div class="small-label">扣除點數</div>
          <input id="redeem-points-input" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input"
            placeholder="例：20" />

          <div class="small-label">備註（選填）</div>
          <input id="redeem-note-input" class="small-input" placeholder="例：假日限定" />

          <div class="quick-row" style="margin-top:10px;">
            <button id="redeem-confirm-btn" class="pill-btn pill-minus" type="button">確認兌換</button>
          </div>
        </div>
      </section>

      <section class="tab-page" data-tab="history">
        <h2>近期點數紀錄 <span id="history-week-label" style="font-size:14px; color:#666; font-weight:normal;"></span></h2>
        <div class="card" id="points-history-card"></div>
      </section>

      <section class="tab-page" data-tab="settings">
        <h2>小孩管理</h2>
        <div class="card settings-group" id="settings-kid-list"></div>

        <h2>一般任務管理 <span id="settings-task-kid-label" style="font-size:14px; color:#666; font-weight:normal;"></span>
        </h2>
        <div class="card settings-group">
          <div id="settings-task-list"></div>
          <div class="settings-item">
            <div style="width: 100%; padding-right: 10px;">
              <div class="settings-label">新增一般任務</div>
              <input id="settings-new-task-input" class="small-input" placeholder="例：主動幫忙做家事..." />
            </div>
            <button id="settings-new-task-btn" class="settings-btn" type="button">新增</button>
          </div>
        </div>

        <h2>Bonus 任務管理 (完成直接+1)</h2>
        <div class="card settings-group">
          <div id="settings-bonus-task-list"></div>
          <div class="settings-item">
            <div style="width: 100%; padding-right: 10px;">
              <div class="settings-label">新增 Bonus 任務</div>
              <input id="settings-new-bonus-task-input" class="small-input" placeholder="例：彈鋼琴、背單字..." />
            </div>
            <button id="settings-new-bonus-task-btn" class="settings-btn" type="button">新增</button>
          </div>
        </div>

        <h2>每日點數規則 <span id="settings-rules-header-label"
            style="font-size:14px; color:#666; font-weight:normal;"></span></h2>
        <div class="card settings-group">
          <!-- Dynamic Rule List -->
          <div id="settings-rules-list"></div>

          <!-- Add Rule UI -->
          <div class="settings-item" style="align-items: flex-start;">
            <div style="flex: 1; padding-right: 10px;">
              <div class="settings-label">新增規則</div>
              <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                <span style="font-size:14px;">完成 ≧</span>
                <input id="rule-threshold-input" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input"
                  style="width:60px; text-align:center;" placeholder="3" />
                <span style="font-size:14px;">項</span>
              </div>
              <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                <span style="font-size:14px;">加</span>
                <input id="rule-points-input" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input"
                  style="width:60px; text-align:center;" placeholder="2" />
                <span style="font-size:14px;">點</span>
              </div>
            </div>
            <button id="btn-add-rule" class="settings-btn" style="margin-top: 10px;">新增</button>
          </div>

          <div class="settings-item">
            <div class="settings-sub" style="color:#888; font-size:13px; line-height:1.4;">
              說明：系統會根據完成的任務數量，取符合條件中「點數最高」的規則來計算本日小計。<br>
              <strong>注意：</strong>修改規則後，該規則僅適用於此小孩。
            </div>
          </div>
        </div>

        <h2>資料選項</h2>
        <div class="card settings-group">

          <div class="settings-item">
            <div style="width: 100%;">
              <div class="settings-label" style="color:#2e7d32;">📤 資料備份 (分享/Email)</div>
              <div class="settings-sub">產生 JSON 檔案並透過系統分享傳送。</div>
              <div class="settings-sub" style="margin-top:8px;">
                <span>上次備份：<span id="last-backup-date">讀取中...</span></span>
                <div id="backup-overdue-msg" class="backup-warning">⚠️ 已超過設定週期，請盡快備份！</div>
              </div>
              <div style="margin-top: 8px;">
                <div class="small-label">預設寄送 Email (僅供紀錄/複製)</div>
                <input id="backup-email-input" class="small-input" placeholder="例：dad@example.com" />
              </div>
              <div style="display:flex; gap:10px; margin-top:12px; align-items:center;">
                <span style="font-size:14px;">提醒週期(天):</span>
                <input id="backup-cycle-input" type="number" value="7" class="small-input"
                  style="width:60px; text-align:center;" />
                <button id="backup-btn" class="settings-btn"
                  style="margin-left:auto; background:#e8f5e9; color:#2e7d32; border-color:#a5d6a7;">立即備份</button>
              </div>
            </div>
          </div>

          <div class="settings-item">
            <div>
              <div class="settings-label" style="color:#1565c0;">📥 還原資料</div>
              <div class="settings-sub">從備份檔 (.json) 還原資料。</div>
            </div>
            <input type="file" id="restore-file-input" accept=".json" style="display:none;" />
            <button onclick="document.getElementById('restore-file-input').click()" class="settings-btn" type="button"
              style="color:#1565c0;border-color:#bbdefb;">還原</button>
          </div>

          <div class="settings-item">
            <div>
              <div class="settings-label" style="color:#333;">🔄 強制更新頁面</div>
              <div class="settings-sub">如果發現功能異常或版本過舊，請點此重整。</div>
            </div>
            <button onclick="window.location.reload(true)" class="settings-btn" type="button">重整</button>
          </div>

          <div class="settings-item">
            <div>
              <div class="settings-label" style="color:#c62828;">重置/登出</div>
              <div class="settings-sub">清除家庭代號與本地紀錄 (雲端資料保留)。</div>
            </div>
            <button id="reset-data-btn" class="settings-btn" type="button"
              style="color:#c62828;border-color:#ffcdd2;">登出</button>
          </div>
        </div>

        <div class="version-info" id="version-display">
          v6.11
        </div>
      </section>
    </main>

    <!-- Modals & Nav & Effects (Same as before) -->
    <nav>
      <div class="nav-item active" data-tab-target="today">
        <span class="nav-icon">📅</span>
        本週
      </div>
      <div class="nav-item" data-tab-target="rewards">
        <span class="nav-icon">🎁</span>
        兌換
      </div>
      <div class="nav-item" data-tab-target="history">
        <span class="nav-icon">📜</span>
        紀錄
      </div>
      <div class="nav-item" data-tab-target="settings">
        <span class="nav-icon">⚙️</span>
        設定
        <div id="settings-notification" class="nav-notification"></div>
      </div>
    </nav>

    <div id="update-banner" onclick="window.location.reload(true)">
      🚀 發現新版本！點此更新
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="edit-kid-modal">
      <div class="modal">
        <h3>編輯小孩資料</h3>
        <input type="hidden" id="edit-kid-key" />
        <div class="form-group">
          <label>顯示名稱 (Name)</label>
          <input id="edit-kid-name" class="small-input" />
        </div>
        <div class="form-group">
          <label>主題顏色</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="edit-kid-theme" value="boy"> 藍色 (Boy)
            </label>
            <label class="radio-label">
              <input type="radio" name="edit-kid-theme" value="girl"> 粉色 (Girl)
            </label>
          </div>
        </div>
        <div class="form-group">
          <label>目前總點數 (可直接修改)</label>
          <input id="edit-kid-points" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input" />
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" id="btn-cancel-edit">取消</button>
          <button class="btn-save" id="btn-save-edit">儲存</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="edit-task-modal">
      <div class="modal">
        <h3>編輯任務</h3>
        <input type="hidden" id="edit-task-id" />
        <input type="hidden" id="edit-task-type" />
        <div class="form-group">
          <label>任務名稱</label>
          <input id="edit-task-name" class="small-input" />
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" id="btn-cancel-task-edit">取消</button>
          <button class="btn-save" id="btn-save-task-edit">儲存</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="week-select-modal">
      <div class="modal">
        <h3>選擇要查看的週次</h3>
        <div id="week-list-container"></div>
        <div class="modal-actions">
          <button class="btn-cancel" onclick="closeWeekSelectModal()">關閉</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="login-modal" style="z-index:99999;">
      <div class="modal" style="max-width:360px;">
        <div class="login-modal-content">
          <div class="login-logo">🏠</div>
          <h3>歡迎使用家庭點數板</h3>
          <p class="login-desc">
            請輸入一個獨特的<b>「家庭代號」</b><br>
            (例如: <code>wang-home-2025</code>)<br>
            其他家人輸入相同代號即可同步資料。
          </p>
          <input id="login-family-id" class="login-input" placeholder="請輸入家庭代號" />
          <button id="login-btn" class="login-btn">開始使用</button>
        </div>
      </div>
    </div>

    <div id="coin-effect" class="coin-effect">🪙</div>
    <div id="deduct-effect" class="deduct-effect">🔻</div>

  </div>

  <script type="module" src="js/main.js"></script>
</body>

</html>