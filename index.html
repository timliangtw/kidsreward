<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å®¶ç”¨é»æ•¸ä»»å‹™æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* ç¦æ­¢ç¸®æ”¾ */
    html, body { 
        touch-action: manipulation; 
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
        background: #f5f5f7; 
        overflow-x: hidden; 
        -webkit-user-select: none;
        user-select: none;
        min-height: 100%;
    }

    input {
        -webkit-user-select: text;
        user-select: text;
    }

    body { font-size: 18px; }

    .app {
      max-width: 480px;
      margin: 16px auto;
      background: white;
      border-radius: 24px;
      box-shadow: 0 0 12px rgba(0,0,0,0.12);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 88vh;
      position: relative; 
    }

    .app.boy header { background: linear-gradient(135deg,#4f8cf7,#7ab8ff); }
    .app.girl header { background: linear-gradient(135deg,#ff7eb3,#ff9a9e); }

    header {
      color: white;
      padding: 18px 18px 14px;
    }
    .header-top { display:flex; justify-content:space-between; align-items:center; }
    .kid-main { display:flex; align-items:center; gap:10px; }
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #ffdd66;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 700;
      font-size: 22px;
      color: #333;
      flex-shrink: 0;
    }
    .kid-info-block { display: flex; flex-direction: column; }
    
    .name-row { display: flex; align-items: center; gap: 8px; }
    .kid-name { font-size: 22px; font-weight: 700; }
    
    .save-badge {
        font-size: 12px;
        background: rgba(255,255,255,0.25);
        padding: 2px 8px;
        border-radius: 10px;
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
        white-space: nowrap;
    }
    .save-badge.show { opacity: 1; }

    .kid-sub { font-size: 14px; opacity: 0.95; }
    
    .switch-btn {
      border: none;
      background: rgba(255,255,255,0.25);
      color: white;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
    }
    .header-bottom {
      margin-top: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 8px;
    }
    
    .date-chip {
      background: rgba(255,255,255,0.25);
      padding: 6px 12px;
      border-radius: 999px;
      white-space: nowrap;
      font-size: 14px;
      cursor: pointer; 
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .date-chip:active { background: rgba(255,255,255,0.4); }
    .date-chip::after { content: "â–¾"; font-size: 12px; opacity: 0.8; }

    .total-points {
      font-size: 26px;
      font-weight: 800;
      display:flex;
      align-items:center;
      gap: 6px;
      white-space: nowrap;
    }

    main {
      padding: 10px 16px 12px;
      flex: 1;
      overflow-y: auto;
    }
    h2 { font-size: 18px; margin: 10px 0 6px; }
    .card {
      background:#fff;
      border-radius:16px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }

    .week-wrapper {
      overflow-x:auto;
      padding-bottom: 6px;
      position: relative;
      scroll-behavior: smooth; 
    }
    .week-table {
      min-width: 640px; 
      border-radius: 16px;
      background:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,0.04);
      padding:10px;
    }
    .week-header, .task-row, .day-summary-row {
      display:flex;
      align-items:center;
      gap: 6px;
      font-size: 14px;
    }
    .week-header { font-weight:700; margin-bottom:6px; }
    
    .task-name-header, .task-name, .task-name-summary {
      flex:0 0 120px;
      min-width:120px;
      font-size:14px;
      font-weight:600;
      position: sticky;
      left: 0;
      background: #fff; 
      z-index: 10;
      box-shadow: 2px 0 5px rgba(0,0,0,0.05); 
      margin-right: -1px;
      align-self: stretch; 
      display: flex;
      align-items: center;
    }
    
    .week-list-item {
        padding: 12px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .week-list-item:last-child { border-bottom: none; }
    .week-list-item.active {
        background-color: #e3f2fd;
        color: #1565c0;
        font-weight: bold;
    }

    .day-header, .day-cell-wrapper, .day-summary-cell {
      flex:1;
      text-align:center;
      display: flex;
      flex-direction: column; 
      justify-content: center;
      align-items: center;
    }
    .date-label {
        font-size: 11px;
        color: #888;
        margin-top: 2px;
        font-weight: normal;
    }

    .custom-check {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 2px solid #ddd;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.1s ease; 
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .custom-check.checked {
      background: #4caf50;
      border-color: #4caf50;
      color: white;
    }
    .custom-check.crossed {
      background: #ffebee;
      border-color: #ffcdd2;
      color: #c62828;
    }

    .task-row { margin-bottom:6px; }
    .day-summary-row {
      margin-top:4px;
      padding-top:4px;
      border-top:1px dashed #eee;
      font-size:13px;
      color:#555;
    }
    .day-summary-cell-positive { color:#2e7d32; font-weight:600; }
    .day-summary-cell-negative { color:#c62828; font-weight:600; }
    .today-col { background:#e3f2fd; border-radius:8px; }

    .history-item { display:flex; justify-content:space-between; margin-bottom:10px; font-size: 15px; }
    .history-main { max-width: 70%; }
    .history-date { font-size: 13px; color:#888; }
    .history-delta { font-weight: 600; font-size: 16px; }
    .history-delete-btn {
      margin-top: 4px;
      padding: 2px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fafafa;
      cursor: pointer;
    }
    .settings-group { margin-bottom: 16px; }
    .settings-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid #eee;
      font-size: 15px;
    }
    .settings-label { font-weight: 600; }
    .settings-sub { font-size: 13px; color:#777; margin-top:2px; }
    .settings-btn {
      border-radius:999px;
      border:1px solid #ddd;
      background:#fafafa;
      padding:6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-row { display:flex; gap:10px; margin-top:6px; }
    .pill-btn {
      flex:1;
      border-radius:999px;
      border:none;
      padding:14px 8px; 
      font-size:16px;
      font-weight: 700;
      cursor:pointer;
    }
    .pill-plus { background:#e3f2fd; color:#1565c0; }
    .pill-minus { background:#ffebee; color:#c62828; }
    .small-label { font-size: 13px; color:#777; margin-top:6px; }
    .small-input {
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #ddd;
      margin-top:4px;
      font-size: 15px;
    }

    .tab-page { display:none; }
    .tab-page.active { display:block; }
    nav {
      display:flex;
      justify-content:space-around;
      border-top:1px solid #ddd;
      background:#fff;
    }
    .nav-item {
      flex:1;
      text-align:center;
      padding:10px 0 12px;
      font-size: 14px;
      cursor:pointer;
      color:#777;
    }
    .nav-icon { display:block; font-size: 20px; margin-bottom:2px; }
    .nav-item.active { color:#3366cc; font-weight:600; }

    #toast-msg { pointer-events: none; }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9990;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: white;
      width: 90%;
      max-width: 400px;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      max-height: 80vh; 
      overflow-y: auto;
    }
    .modal h3 { margin-bottom: 16px; font-size: 20px; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px; color: #555; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .btn-cancel { background: #f5f5f5; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 15px; }
    .btn-save { background: #4f8cf7; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; }
    
    .radio-group { display: flex; gap: 16px; }
    .radio-label { display: flex; align-items: center; gap: 6px; font-size: 15px; cursor: pointer; }

    input[type="number"], input[type="text"] { font-size: 16px; }

    /* ç‰¹æ•ˆå‹•ç•« */
    .coin-effect {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 80px;
      pointer-events: none;
      z-index: 10000;
      display: none;
    }
    .coin-effect.animate {
      display: block;
      animation: coinUp 0.6s ease-out forwards;
    }
    @keyframes coinUp {
      0% { transform: translate(-50%, -20%) scale(0); opacity: 0; }
      20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -200%) scale(1); opacity: 0; }
    }

    .deduct-effect {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 80px;
      pointer-events: none;
      z-index: 10000;
      display: none;
      color: #c62828;
    }
    .deduct-effect.animate {
      display: block;
      animation: dropDown 0.6s ease-in forwards;
    }
    @keyframes dropDown {
      0% { transform: translate(-50%, -100%) scale(0); opacity: 0; }
      20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, 150%) scale(0.8); opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="app boy">
    <header>
      <div class="header-top">
        <div class="kid-main">
          <div class="avatar">L</div>
          <div class="kid-info-block">
            <div class="name-row">
                <div class="kid-name">Leo</div>
                <div id="save-badge" class="save-badge">âœ… å·²å„²å­˜</div>
            </div>
            <div class="kid-sub">ä»Šå¤©ä¸€èµ·åŠ æ²¹ ğŸ’ª</div>
          </div>
        </div>
        <button class="switch-btn" type="button">åˆ‡æ›å°å­© â–¾</button>
      </div>
      <div class="header-bottom">
        <div class="date-chip" id="date-chip" onclick="openWeekSelectModal()">æœ¬é€±ï¼š-- / --</div>
        <div class="total-points" id="total-points">
          <span>â­</span>
          <span>0 é»</span>
        </div>
      </div>
    </header>

    <main>
      <section class="tab-page active" data-tab="today">
        <h2>ä»»å‹™è¡¨ <span id="viewing-week-label" style="font-size:14px; color:#666; font-weight:normal;">(æœ¬é€±)</span></h2>
        <div class="week-wrapper">
        <div class="week-table" id="week-table"></div>
        </div>

        <h2>å¿«é€ŸåŠ  / æ‰£é»ï¼ˆçˆ¸åª½ï¼‰</h2>
        <div class="card" id="quick-points-card">
          <div class="small-label">èª¿æ•´ä»Šå¤©çš„é»æ•¸ï¼ˆä¹Ÿæœƒå½±éŸ¿ç¸½é»æ•¸ï¼‰</div>
          <div class="quick-row">
            <button class="pill-btn pill-plus" type="button">+1 é»</button>
            <button class="pill-btn pill-minus" type="button">-1 é»</button>
          </div>
          <div class="small-label">å‚™è¨»ï¼ˆé¸å¡«ï¼Œè¨˜éŒ„åŸå› ï¼‰</div>
          <input class="small-input" id="quick-note-input" placeholder="ä¾‹ï¼šä»Šå¤©ä¸»å‹•å¹«å¿™æ”¶ç©å…· +1 é»" />
        </div>
      </section>

      <section class="tab-page" data-tab="rewards">
        <h2>é»æ•¸å…Œæ›</h2>
        <div class="card">
          <div style="font-size:16px; margin-bottom:4px;">
            ç›®å‰å°å­©ï¼š<strong><span id="redeem-kid-name">Leo</span></strong>
          </div>
          <div style="font-size:15px;">
            å¯ç”¨ç¸½é»æ•¸ï¼š<span id="redeem-kid-points" style="font-size:22px;font-weight:800;">0</span> é»
          </div>
          <div style="font-size:13px;color:#777;margin-top:6px;">
            ï¼ˆé€™è£¡é¡¯ç¤ºçš„æ˜¯ç›®å‰é€™ä½å°å­©çš„ç¸½é»æ•¸ï¼Œå…Œæ›æ™‚æœƒå¾é€™è£¡æ‰£é™¤ï¼‰
          </div>
        </div>

        <h2>è¼¸å…¥å…Œæ›å…§å®¹</h2>
        <div class="card">
          <div class="small-label">å…Œæ›åç¨±</div>
          <input id="redeem-name-input" class="small-input" placeholder="ä¾‹ï¼šå»çœ‹ç«è»Šã€æ›ä¸€å€‹ç©å…·..." />

          <div class="small-label">æ‰£é™¤é»æ•¸</div>
          <input id="redeem-points-input" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input" placeholder="ä¾‹ï¼š20" />

          <div class="small-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</div>
          <input id="redeem-note-input" class="small-input" placeholder="ä¾‹ï¼šå‡æ—¥é™å®š" />

          <div class="quick-row" style="margin-top:10px;">
            <button id="redeem-confirm-btn" class="pill-btn pill-minus" type="button">ç¢ºèªå…Œæ›</button>
          </div>
        </div>
      </section>

      <section class="tab-page" data-tab="history">
        <h2>è¿‘æœŸé»æ•¸ç´€éŒ„</h2>
        <div class="card" id="points-history-card"></div>
      </section>

      <section class="tab-page" data-tab="settings">
        <h2>å°å­©ç®¡ç†</h2>
        <div class="card settings-group" id="settings-kid-list"></div>

        <h2>ä»»å‹™ç®¡ç† <span id="settings-task-kid-label" style="font-size:14px; color:#666; font-weight:normal;"></span></h2>
        <div class="card settings-group">
          <div id="settings-task-list"></div>
          <div class="settings-item">
            <div style="width: 100%; padding-right: 10px;">
              <div class="settings-label">æ–°å¢ä»»å‹™</div>
              <input id="settings-new-task-input" class="small-input" placeholder="ä¾‹ï¼šä¸»å‹•å¹«å¿™åšå®¶äº‹..." />
            </div>
            <button id="settings-new-task-btn" class="settings-btn" type="button">æ–°å¢</button>
          </div>
        </div>

        <h2>æ¯æ—¥é»æ•¸è¦å‰‡</h2>
        <div class="card settings-group">
          <!-- Dynamic Rule List -->
          <div id="settings-rules-list"></div>

          <!-- Add Rule UI -->
          <div class="settings-item" style="align-items: flex-start;">
            <div style="flex: 1; padding-right: 10px;">
              <div class="settings-label">æ–°å¢è¦å‰‡</div>
              <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                 <span style="font-size:14px;">å®Œæˆ â‰§</span>
                 <input id="rule-threshold-input" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input" style="width:60px; text-align:center;" placeholder="3" />
                 <span style="font-size:14px;">é …</span>
              </div>
              <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                 <span style="font-size:14px;">åŠ </span>
                 <input id="rule-points-input" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input" style="width:60px; text-align:center;" placeholder="2" />
                 <span style="font-size:14px;">é»</span>
              </div>
            </div>
            <button id="btn-add-rule" class="settings-btn" style="margin-top: 10px;">æ–°å¢</button>
          </div>
          
          <div class="settings-item">
             <div class="settings-sub" style="color:#888; font-size:13px; line-height:1.4;">
               èªªæ˜ï¼šç³»çµ±æœƒæ ¹æ“šå®Œæˆçš„ä»»å‹™æ•¸é‡ï¼Œå–ç¬¦åˆæ¢ä»¶ä¸­ã€Œé»æ•¸æœ€é«˜ã€çš„è¦å‰‡ä¾†è¨ˆç®—æœ¬æ—¥å°è¨ˆã€‚
             </div>
          </div>
        </div>

        <h2>è³‡æ–™é¸é …</h2>
        <div class="card settings-group">
          <div class="settings-item">
            <div>
              <div class="settings-label" style="color:#c62828;">é‡ç½®æ‰€æœ‰è³‡æ–™</div>
              <div class="settings-sub">æ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Œå›åˆ°åˆå§‹ç‹€æ…‹ã€‚</div>
            </div>
            <button id="reset-data-btn" class="settings-btn" type="button" style="color:#c62828;border-color:#ffcdd2;">é‡ç½®</button>
          </div>
        </div>
      </section>
    </main>

    <nav>
      <div class="nav-item active" data-tab-target="today">
        <span class="nav-icon">ğŸ“…</span>
        æœ¬é€±
      </div>
      <div class="nav-item" data-tab-target="rewards">
        <span class="nav-icon">ğŸ</span>
        å…Œæ›
      </div>
      <div class="nav-item" data-tab-target="history">
        <span class="nav-icon">ğŸ“œ</span>
        ç´€éŒ„
      </div>
      <div class="nav-item" data-tab-target="settings">
        <span class="nav-icon">âš™ï¸</span>
        è¨­å®š
      </div>
    </nav>

    <!-- ç·¨è¼¯å°å­© Modal -->
    <div class="modal-overlay" id="edit-kid-modal">
      <div class="modal">
        <h3>ç·¨è¼¯å°å­©è³‡æ–™</h3>
        <input type="hidden" id="edit-kid-key" />
        <div class="form-group">
          <label>é¡¯ç¤ºåç¨± (Name)</label>
          <input id="edit-kid-name" class="small-input" />
        </div>
        <div class="form-group">
          <label>ä¸»é¡Œé¡è‰²</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="edit-kid-theme" value="boy"> è—è‰² (Boy)
            </label>
            <label class="radio-label">
              <input type="radio" name="edit-kid-theme" value="girl"> ç²‰è‰² (Girl)
            </label>
          </div>
        </div>
        <div class="form-group">
          <label>ç›®å‰ç¸½é»æ•¸ (å¯ç›´æ¥ä¿®æ”¹)</label>
          <input id="edit-kid-points" type="number" inputmode="numeric" pattern="[0-9]*" class="small-input" />
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" id="btn-cancel-edit">å–æ¶ˆ</button>
          <button class="btn-save" id="btn-save-edit">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- é€±æ¬¡é¸æ“‡ Modal -->
    <div class="modal-overlay" id="week-select-modal">
        <div class="modal">
            <h3>é¸æ“‡è¦æŸ¥çœ‹çš„é€±æ¬¡</h3>
            <div id="week-list-container"></div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeWeekSelectModal()">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- ç‰¹æ•ˆå…ƒç´  -->
    <div id="coin-effect" class="coin-effect">ğŸª™</div>
    <div id="deduct-effect" class="deduct-effect">ğŸ”»</div>

  </div>

  <script>
    // å¼·åŠ›ç¦æ­¢ç¸®æ”¾é‚è¼¯
    document.addEventListener('gesturestart', function (e) { e.preventDefault(); }, { passive: false });
    document.addEventListener('gesturechange', function (e) { e.preventDefault(); }, { passive: false });
    document.addEventListener('gestureend', function (e) { e.preventDefault(); }, { passive: false });
    document.addEventListener('touchmove', function(event) {
        if (event.touches.length > 1) { event.preventDefault(); }
    }, { passive: false });

    function showToast(msg) {
      var toast = document.getElementById('toast-msg');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-msg';
        toast.style.position = 'fixed';
        toast.style.bottom = '80px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = 'rgba(0,0,0,0.8)';
        toast.style.color = '#fff';
        toast.style.padding = '10px 20px';
        toast.style.borderRadius = '20px';
        toast.style.zIndex = '9999';
        toast.style.fontSize = '14px';
        toast.style.transition = 'opacity 0.5s';
        toast.style.opacity = '0';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.style.opacity = '1';
      setTimeout(function() { toast.style.opacity = '0'; }, 2000);
    }
    
    function playCoinSound() {
        var AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        var ctx = new AudioContext();
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'square';
        osc.frequency.setValueAtTime(987.77, ctx.currentTime); 
        osc.frequency.setValueAtTime(1318.51, ctx.currentTime + 0.08);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
        osc.start(); osc.stop(ctx.currentTime + 0.4);
    }
    function showCoinAnimation() {
        var coin = document.getElementById('coin-effect');
        if(coin) { coin.classList.remove('animate'); void coin.offsetWidth; coin.classList.add('animate'); }
    }
    function playDeductSound() {
        var AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        var ctx = new AudioContext();
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(300, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start(); osc.stop(ctx.currentTime + 0.3);
    }
    function showDeductAnimation() {
        var elem = document.getElementById('deduct-effect');
        if(elem) { elem.classList.remove('animate'); void elem.offsetWidth; elem.classList.add('animate'); }
    }

    var navItems = document.querySelectorAll('.nav-item');
    var pages = document.querySelectorAll('.tab-page');
    navItems.forEach(function(item) {
      item.addEventListener('click', function() {
        var target = item.getAttribute('data-tab-target');
        navItems.forEach(function(n) { n.classList.remove('active'); });
        item.classList.add('active');
        pages.forEach(function(page) {
          if (page.getAttribute('data-tab') === target) page.classList.add('active');
          else page.classList.remove('active');
        });
        if(target === 'today') setTimeout(highlightTodayColumn, 100);
      });
    });

    function getMonday(d) {
        d = new Date(d);
        var day = d.getDay();
        var diff = d.getDate() - day + (day == 0 ? -6 : 1);
        var monday = new Date(d.setDate(diff));
        monday.setHours(0,0,0,0);
        return monday;
    }
    function formatDateKey(d) {
        var year = d.getFullYear();
        var month = (d.getMonth() + 1).toString().padStart(2, '0');
        var day = d.getDate().toString().padStart(2, '0');
        return year + '-' + month + '-' + day;
    }
    function getCurrentWeekKey() {
        return formatDateKey(getMonday(new Date()));
    }
    function getWeekRangeString(mondayStr) {
        var monday = new Date(mondayStr);
        var sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        return (monday.getMonth()+1) + '/' + monday.getDate() + " ï½ " + (sunday.getMonth()+1) + '/' + sunday.getDate();
    }

    var currentViewWeekKey = getCurrentWeekKey();

    var STORAGE_KEY = 'family_points_data_v9'; 
    
    var defaultRules = [
      { threshold: 3, points: 2 }, 
      { threshold: 1, points: 1 }
    ];
    var rulesState = JSON.parse(JSON.stringify(defaultRules));
    
    var defaultCommonTasks = [
      { id: 'dress', name: 'è‡ªå·±ç©¿å¥½è¡£æœ' },
      { id: 'hw',    name: 'å¯«å®Œå›å®¶ä½œæ¥­' },
      { id: 'toys',  name: 'ç¡å‰æ”¶ç©å…·' }
    ];

    var defaultKidsState = {
      leo: {
        key: 'leo', displayName: 'Leo', avatar: 'L', slogan: 'ä»Šå¤©ä¸€èµ·åŠ æ²¹ ğŸ’ª', theme: 'boy',
        totalPoints: 0,
        dataByWeek: {}, 
        history: [],
        tasks: JSON.parse(JSON.stringify(defaultCommonTasks))
      },
      natasha: {
        key: 'natasha', displayName: 'Natasha', avatar: 'N', slogan: 'ä¸€èµ·é–‹å¿ƒç©è€ ğŸŒˆ', theme: 'girl',
        totalPoints: 0,
        dataByWeek: {},
        history: [],
        tasks: JSON.parse(JSON.stringify(defaultCommonTasks))
      }
    };

    var kidsState = JSON.parse(JSON.stringify(defaultKidsState));
    var currentKid = 'leo';

    function saveData() {
      var data = { kids: kidsState, rules: rulesState };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      triggerSaveIndicator();
    }

    function triggerSaveIndicator() {
        var badge = document.getElementById('save-badge');
        if(badge) {
            badge.classList.add('show');
            setTimeout(function(){ badge.classList.remove('show'); }, 1500);
        }
    }

    function loadData() {
      var raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          var data = JSON.parse(raw);
          var legacyTasks = data.tasks || defaultCommonTasks;
          if (data.kids) {
             Object.keys(data.kids).forEach(k => {
                 var kid = data.kids[k];
                 if((kid.weeklyStatus || kid.dailySummary) && !kid.dataByWeek) {
                     kid.dataByWeek = {};
                     var thisWeek = getCurrentWeekKey();
                     kid.dataByWeek[thisWeek] = {
                         status: kid.weeklyStatus || [{},{},{},{},{},{},{}],
                         summary: kid.dailySummary || [0,0,0,0,0,0,0]
                     };
                     delete kid.weeklyStatus; delete kid.dailySummary;
                 }
                 if(!kid.dataByWeek) kid.dataByWeek = {};
                 if (!kid.tasks) kid.tasks = JSON.parse(JSON.stringify(legacyTasks));
             });
             kidsState = data.kids;
          }
          if (data.rules && Array.isArray(data.rules)) {
              rulesState = data.rules;
          }
        } catch (e) { console.error('Load failed', e); }
      }
    }

    function performReset() {
      localStorage.removeItem(STORAGE_KEY);
      kidsState = JSON.parse(JSON.stringify(defaultKidsState));
      rulesState = JSON.parse(JSON.stringify(defaultRules));
      currentKid = 'leo';
      currentViewWeekKey = getCurrentWeekKey(); 
      renderAll();
      showToast('è³‡æ–™å·²é‡ç½®');
    }
    
    function renderAll() {
        renderCurrentKid();
        renderWeekTable();
        renderHistoryList();
        renderSettingsTaskList();
        renderSettingsKidList();
        renderSettingsRulesList(); 
    }

    var appEl = document.querySelector('.app');
    var switchBtn = document.querySelector('.switch-btn');
    var kidNameEl = document.querySelector('.kid-name');
    var avatarEl = document.querySelector('.avatar');
    var kidSubEl = document.querySelector('.kid-sub');
    var totalPointsEl = document.getElementById('total-points');
    var dateChipEl = document.getElementById('date-chip');
    var viewLabelEl = document.getElementById('viewing-week-label'); 
    var settingsTaskKidLabel = document.getElementById('settings-task-kid-label'); 

    var redeemKidNameEl = document.getElementById('redeem-kid-name');
    var redeemKidPointsEl = document.getElementById('redeem-kid-points');
    var redeemNameInput = document.getElementById('redeem-name-input');
    var redeemPointsInput = document.getElementById('redeem-points-input');
    var redeemNoteInput = document.getElementById('redeem-note-input');
    var redeemConfirmBtn = document.getElementById('redeem-confirm-btn');
    
    var quickPlusBtn = document.querySelector('#quick-points-card .pill-plus');
    var quickMinusBtn = document.querySelector('#quick-points-card .pill-minus');
    var quickNoteInput = document.getElementById('quick-note-input');
    var historyCard = document.getElementById('points-history-card');
    
    var settingsTaskListEl = document.getElementById('settings-task-list');
    var settingsNewTaskInput = document.getElementById('settings-new-task-input');
    var settingsNewTaskBtn = document.getElementById('settings-new-task-btn');
    var settingsKidListEl = document.getElementById('settings-kid-list');
    
    var settingsRulesListEl = document.getElementById('settings-rules-list');
    var ruleThresholdInput = document.getElementById('rule-threshold-input');
    var rulePointsInput = document.getElementById('rule-points-input');
    var btnAddRule = document.getElementById('btn-add-rule');

    var editKidModal = document.getElementById('edit-kid-modal');
    var editKidKeyInput = document.getElementById('edit-kid-key');
    var editKidNameInput = document.getElementById('edit-kid-name');
    var editKidPointsInput = document.getElementById('edit-kid-points');
    var btnCancelEdit = document.getElementById('btn-cancel-edit');
    var btnSaveEdit = document.getElementById('btn-save-edit');
    var resetDataBtn = document.getElementById('reset-data-btn');
    var weekSelectModal = document.getElementById('week-select-modal');
    var weekListContainer = document.getElementById('week-list-container');

    if (resetDataBtn) {
      resetDataBtn.addEventListener('click', function() {
        if (resetDataBtn.textContent !== 'ç¢ºå®šé‡ç½®ï¼Ÿ') {
          resetDataBtn.textContent = 'ç¢ºå®šé‡ç½®ï¼Ÿ';
          resetDataBtn.style.backgroundColor = '#ffebee'; 
          setTimeout(function() {
            if (resetDataBtn.parentElement) { 
              resetDataBtn.textContent = 'é‡ç½®';
              resetDataBtn.style.backgroundColor = '';
            }
          }, 3000);
        } else {
          performReset();
          resetDataBtn.textContent = 'é‡ç½®';
          resetDataBtn.style.backgroundColor = '';
        }
      });
    }

    function formatDailySummary(value) { return (value >= 0 ? '+' : '') + value; }
    function getTodayColumnIndex() {
      var d = new Date().getDay();
      return (d === 0) ? 6 : d - 1; 
    }

    function getWeekData(kid, weekKey) {
        if(!kid.dataByWeek[weekKey]) {
            kid.dataByWeek[weekKey] = {
                status: [{},{},{},{},{},{},{}],
                summary: [0,0,0,0,0,0,0]
            };
        }
        return kid.dataByWeek[weekKey];
    }

    function calculateDailyTotal(kid, weekKey, dayIndex) {
      var weekData = getWeekData(kid, weekKey);
      var dayStatus = weekData.status[dayIndex] || {};
      var checkedCount = 0;
      Object.values(dayStatus).forEach(status => {
          if (status === 'checked') checkedCount++;
      });
      
      var rulePoints = 0;
      var maxPoints = 0;
      var matched = false;
      rulesState.forEach(function(rule) {
        if (checkedCount >= rule.threshold) {
          if (rule.points > maxPoints) {
            maxPoints = rule.points;
            matched = true;
          }
        }
      });
      if (matched) rulePoints = maxPoints;
      var manualPoints = weekData.summary[dayIndex] || 0;
      return rulePoints + manualPoints;
    }

    function renderCurrentKid() {
        var kid = kidsState[currentKid];
        kidNameEl.textContent = kid.displayName;
        avatarEl.textContent = kid.avatar;
        kidSubEl.textContent = kid.slogan;
        appEl.classList.remove('boy', 'girl');
        appEl.classList.add(kid.theme);
        totalPointsEl.innerHTML = '<span>â­</span><span>' + kid.totalPoints + ' é»</span>';
        dateChipEl.textContent = 'é€±æ¬¡ï¼š' + getWeekRangeString(currentViewWeekKey);
        var thisWeek = getCurrentWeekKey();
        if(currentViewWeekKey === thisWeek) {
            viewLabelEl.textContent = "(æœ¬é€±)";
            viewLabelEl.style.color = "#2e7d32";
        } else {
            viewLabelEl.textContent = "(æ­·å²ç´€éŒ„)";
            viewLabelEl.style.color = "#c62828";
        }
        redeemKidNameEl.textContent = kid.displayName;
        redeemKidPointsEl.textContent = kid.totalPoints;
        if(settingsTaskKidLabel) settingsTaskKidLabel.textContent = "(ç®¡ç†å°è±¡ï¼š" + kid.displayName + ")";
    }

    function renderWeekTable() {
      var container = document.getElementById('week-table');
      if (!container) return;
      container.innerHTML = '';
      var weekDays = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
      var mondayDate = new Date(currentViewWeekKey);
      var dates = [];
      for(var i=0; i<7; i++) {
          var d = new Date(mondayDate);
          d.setDate(mondayDate.getDate() + i);
          dates.push((d.getMonth()+1) + '/' + d.getDate());
      }
      var headerRow = document.createElement('div');
      headerRow.className = 'week-header';
      var taskHeader = document.createElement('div');
      taskHeader.className = 'task-name-header';
      taskHeader.textContent = 'ä»»å‹™';
      headerRow.appendChild(taskHeader);
      weekDays.forEach((label, idx) => {
        var cell = document.createElement('div');
        cell.className = 'day-header';
        cell.setAttribute('data-day-index', idx);
        cell.innerHTML = `<div>${label}</div><div class="date-label">${dates[idx]}</div>`;
        headerRow.appendChild(cell);
      });
      container.appendChild(headerRow);
      var summaryRow = document.createElement('div');
      summaryRow.className = 'day-summary-row';
      var summaryName = document.createElement('div');
      summaryName.className = 'task-name-summary';
      summaryName.textContent = 'æœ¬æ—¥å°è¨ˆ';
      summaryRow.appendChild(summaryName);
      var kid = kidsState[currentKid];
      for (var i = 0; i < 7; i++) {
        var total = calculateDailyTotal(kid, currentViewWeekKey, i);
        var cell = document.createElement('div');
        cell.className = 'day-summary-cell';
        cell.setAttribute('data-day-index', i);
        cell.textContent = formatDailySummary(total);
        if (total > 0) cell.classList.add('day-summary-cell-positive');
        else if (total < 0) cell.classList.add('day-summary-cell-negative');
        summaryRow.appendChild(cell);
      }
      container.appendChild(summaryRow);
      var currentTasks = kid.tasks || [];
      var weekData = getWeekData(kid, currentViewWeekKey);
      currentTasks.forEach(function(task) {
        var row = document.createElement('div');
        row.className = 'task-row';
        var nameDiv = document.createElement('div');
        nameDiv.className = 'task-name';
        nameDiv.textContent = task.name;
        row.appendChild(nameDiv);
        [0, 1, 2, 3, 4, 5, 6].forEach(function(i) {
          var wrapper = document.createElement('div');
          wrapper.className = 'day-cell-wrapper';
          wrapper.setAttribute('data-day-index', i);
          var checkDiv = document.createElement('div');
          checkDiv.className = 'custom-check';
          var status = (weekData.status[i]) ? weekData.status[i][task.id] : undefined;
          if (status === 'checked') { checkDiv.classList.add('checked'); checkDiv.textContent = 'âœ”'; }
          else if (status === 'crossed') { checkDiv.classList.add('crossed'); checkDiv.textContent = 'âœ˜'; }
          else { checkDiv.textContent = ''; }
          checkDiv.onclick = function() { handleTaskClick(i, task.id); };
          wrapper.appendChild(checkDiv);
          row.appendChild(wrapper);
        });
        container.appendChild(row);
      });
      if(currentViewWeekKey === getCurrentWeekKey()) highlightTodayColumn();
    }
    
    function highlightTodayColumn() {
        var idx = getTodayColumnIndex();
        var headers = document.querySelectorAll('.day-header[data-day-index="'+idx+'"]');
        var cells = document.querySelectorAll('.day-cell-wrapper[data-day-index="'+idx+'"]');
        var summary = document.querySelectorAll('.day-summary-cell[data-day-index="'+idx+'"]');
        headers.forEach(el => el.classList.add('today-col'));
        cells.forEach(el => el.classList.add('today-col'));
        summary.forEach(el => el.classList.add('today-col'));
        var wrapper = document.querySelector('.week-wrapper');
        var targetCell = headers[0];
        if (wrapper && targetCell) {
            var scrollLeft = targetCell.offsetLeft - wrapper.offsetLeft - (wrapper.clientWidth / 2) + (targetCell.clientWidth / 2);
            wrapper.scrollTo({ left: scrollLeft, behavior: 'smooth' });
        }
    }

    function handleTaskClick(dayIndex, taskId) {
      var kid = kidsState[currentKid];
      var weekData = getWeekData(kid, currentViewWeekKey);
      if (!weekData.status[dayIndex]) weekData.status[dayIndex] = {};
      var currentStatus = weekData.status[dayIndex][taskId]; 
      var oldDailyTotal = calculateDailyTotal(kid, currentViewWeekKey, dayIndex);
      if (!currentStatus) weekData.status[dayIndex][taskId] = 'checked';
      else if (currentStatus === 'checked') weekData.status[dayIndex][taskId] = 'crossed';
      else delete weekData.status[dayIndex][taskId];
      var newDailyTotal = calculateDailyTotal(kid, currentViewWeekKey, dayIndex);
      var diff = newDailyTotal - oldDailyTotal;
      if (diff !== 0) {
        kid.totalPoints += diff;
        if (kid.totalPoints < 0) kid.totalPoints = 0;
      }
      saveData(); renderWeekTable(); renderCurrentKid();
    }

    // ===== Settings Logic =====
    function renderSettingsKidList() {
      if (!settingsKidListEl) return;
      settingsKidListEl.innerHTML = '';
      Object.keys(kidsState).forEach(function(key) {
        var kid = kidsState[key];
        var item = document.createElement('div');
        item.className = 'settings-item';
        var infoDiv = document.createElement('div');
        var nameDiv = document.createElement('div');
        nameDiv.className = 'settings-label';
        nameDiv.textContent = kid.displayName;
        var subDiv = document.createElement('div');
        subDiv.className = 'settings-sub';
        var themeName = kid.theme === 'boy' ? 'è—è‰²' : 'ç²‰è‰²';
        subDiv.textContent = 'ä»£è¡¨é¡è‰²ï¼š' + themeName + ' Â· ç¸½é»æ•¸ ' + kid.totalPoints;
        infoDiv.appendChild(nameDiv); infoDiv.appendChild(subDiv);
        var btn = document.createElement('button');
        btn.className = 'settings-btn';
        btn.textContent = 'ç·¨è¼¯';
        btn.type = 'button';
        btn.addEventListener('click', function() { openEditKidModal(key); });
        item.appendChild(infoDiv); item.appendChild(btn);
        settingsKidListEl.appendChild(item);
      });
    }

    function renderSettingsTaskList() {
      if (!settingsTaskListEl) return;
      settingsTaskListEl.innerHTML = ''; 
      var currentTasks = kidsState[currentKid].tasks || [];
      currentTasks.forEach(function(task) {
        var item = document.createElement('div');
        item.className = 'settings-item';
        var infoDiv = document.createElement('div');
        var nameDiv = document.createElement('div');
        nameDiv.className = 'settings-label';
        nameDiv.textContent = task.name;
        var subDiv = document.createElement('div');
        subDiv.className = 'settings-sub';
        subDiv.textContent = 'é¡¯ç¤ºåœ¨æœ¬é€±ä»»å‹™è¡¨';
        infoDiv.appendChild(nameDiv); infoDiv.appendChild(subDiv);
        var btn = document.createElement('button');
        btn.className = 'settings-btn';
        btn.textContent = 'åˆªé™¤';
        btn.type = 'button';
        btn.addEventListener('click', function() {
          if (btn.textContent !== 'ç¢ºå®šï¼Ÿ') {
             btn.textContent = 'ç¢ºå®šï¼Ÿ'; btn.style.color = '#c62828';
             setTimeout(function(){ if(btn.parentElement) { btn.textContent = 'åˆªé™¤'; btn.style.color = ''; } }, 3000);
           } else { handleDeleteTask(task.id); }
        });
        item.appendChild(infoDiv); item.appendChild(btn);
        settingsTaskListEl.appendChild(item);
      });
    }

    function handleAddTask() {
      if (!settingsNewTaskInput) return;
      var val = settingsNewTaskInput.value.trim();
      if (!val) { showToast('è«‹è¼¸å…¥ä»»å‹™åç¨±'); return; }
      var currentTasks = kidsState[currentKid].tasks;
      currentTasks.push({ id: 't_' + Date.now(), name: val });
      settingsNewTaskInput.value = '';
      saveData(); renderAll(); showToast('ä»»å‹™å·²æ–°å¢');
    }
    function handleDeleteTask(taskId) {
        var currentTasks = kidsState[currentKid].tasks;
        kidsState[currentKid].tasks = currentTasks.filter(t => t.id !== taskId);
        saveData(); renderAll(); showToast('ä»»å‹™å·²åˆªé™¤');
    }
    if(settingsNewTaskBtn) settingsNewTaskBtn.addEventListener('click', handleAddTask);

    // --- Rules Logic (Fixed) ---
    function renderSettingsRulesList() {
        if (!settingsRulesListEl) return;
        settingsRulesListEl.innerHTML = '';
        rulesState.sort((a,b) => a.threshold - b.threshold);

        rulesState.forEach((rule, index) => {
            var item = document.createElement('div');
            item.className = 'settings-item';
            
            var infoDiv = document.createElement('div');
            var labelDiv = document.createElement('div');
            labelDiv.className = 'settings-label';
            labelDiv.textContent = 'è¦å‰‡ ' + (index + 1);
            
            var subDiv = document.createElement('div');
            subDiv.className = 'settings-sub';
            subDiv.textContent = `å®Œæˆ â‰§ ${rule.threshold} é …ä»»å‹™ â†’ ç•¶å¤©åŠ  ${rule.points} é»`;
            
            infoDiv.appendChild(labelDiv);
            infoDiv.appendChild(subDiv);
            
            var btn = document.createElement('button');
            btn.className = 'settings-btn';
            btn.type = 'button';
            btn.textContent = 'åˆªé™¤';
            
            btn.onclick = function() {
                if(btn.textContent !== 'ç¢ºå®šï¼Ÿ') {
                    btn.textContent = 'ç¢ºå®šï¼Ÿ';
                    btn.style.color = '#c62828';
                    btn.style.borderColor = '#c62828';
                    setTimeout(function(){
                        if(btn) {
                            btn.textContent = 'åˆªé™¤';
                            btn.style.color = '';
                            btn.style.borderColor = '';
                        }
                    }, 3000);
                } else {
                    rulesState.splice(index, 1);
                    saveData();
                    renderAll(); 
                    showToast('è¦å‰‡å·²åˆªé™¤');
                }
            };
            
            item.appendChild(infoDiv);
            item.appendChild(btn);
            settingsRulesListEl.appendChild(item);
        });
    }

    function handleAddRule() {
        var tVal = parseInt(ruleThresholdInput.value, 10);
        var pVal = parseInt(rulePointsInput.value, 10);
        
        if(isNaN(tVal) || tVal <= 0) { showToast('è«‹è¼¸å…¥æ­£ç¢ºçš„é …ç›®æ•¸'); return; }
        if(isNaN(pVal) || pVal <= 0) { showToast('è«‹è¼¸å…¥æ­£ç¢ºçš„é»æ•¸'); return; }
        
        var exists = rulesState.some(r => r.threshold === tVal);
        if(exists) { showToast('å·²æœ‰ç›¸åŒé …ç›®æ•¸çš„è¦å‰‡'); return; }
        
        rulesState.push({ threshold: tVal, points: pVal });
        ruleThresholdInput.value = '';
        rulePointsInput.value = '';
        saveData();
        renderAll();
        showToast('è¦å‰‡å·²æ–°å¢');
    }
    if(btnAddRule) btnAddRule.addEventListener('click', handleAddRule);


    function openWeekSelectModal() {
        weekListContainer.innerHTML = '';
        var kid = kidsState[currentKid];
        var thisWeek = getCurrentWeekKey();
        var weekKeys = Object.keys(kid.dataByWeek || {});
        if(!weekKeys.includes(thisWeek)) weekKeys.push(thisWeek);
        weekKeys.sort().reverse();
        weekKeys.forEach(key => {
            var div = document.createElement('div');
            div.className = 'week-list-item';
            if(key === currentViewWeekKey) div.classList.add('active');
            var label = getWeekRangeString(key);
            if(key === thisWeek) label += " (æœ¬é€±)";
            div.textContent = label;
            div.onclick = function() { currentViewWeekKey = key; renderAll(); closeWeekSelectModal(); };
            weekListContainer.appendChild(div);
        });
        weekSelectModal.classList.add('open');
    }
    function closeWeekSelectModal() { weekSelectModal.classList.remove('open'); }
    
    function addHistory(kid, desc, delta) {
        var now = new Date();
        var dateStr = (now.getMonth()+1) + '/' + now.getDate() + ' ' + now.getHours() + ':' + (now.getMinutes()<10?'0':'') + now.getMinutes();
        kid.history.unshift({ desc: desc, delta: delta, date: dateStr, id: Date.now() });
        if(kid.history.length > 50) kid.history.pop();
    }
    function renderHistoryList() {
        var kid = kidsState[currentKid];
        historyCard.innerHTML = '';
        if (!kid.history || kid.history.length === 0) { historyCard.innerHTML = '<div style="color:#777;text-align:center;padding:10px;">å°šç„¡ç´€éŒ„</div>'; return; }
        kid.history.forEach(function(h, index) {
            var item = document.createElement('div');
            item.className = 'history-item';
            var left = document.createElement('div');
            left.className = 'history-main';
            left.innerHTML = `<div>${h.desc}</div><div class="history-date">${h.date}</div>`;
            var right = document.createElement('div');
            right.style.textAlign = 'right';
            var deltaDiv = document.createElement('div');
            deltaDiv.className = 'history-delta';
            var sign = h.delta > 0 ? '+' : '';
            deltaDiv.textContent = sign + h.delta;
            deltaDiv.style.color = h.delta > 0 ? '#2e7d32' : '#c62828';
            var delBtn = document.createElement('button');
            delBtn.className = 'history-delete-btn';
            delBtn.textContent = 'åˆªé™¤';
            delBtn.onclick = function() {
                if(confirm('ç¢ºå®šåˆªé™¤é€™æ¢ç´€éŒ„ï¼Ÿ')) {
                    kid.totalPoints -= h.delta;
                    if(kid.totalPoints < 0) kid.totalPoints = 0;
                    kid.history.splice(index, 1);
                    saveData(); renderHistoryList(); renderCurrentKid();
                }
            };
            right.appendChild(deltaDiv); right.appendChild(delBtn);
            item.appendChild(left); item.appendChild(right);
            historyCard.appendChild(item);
        });
    }

    if(quickPlusBtn) {
        quickPlusBtn.onclick = function() {
            var kid = kidsState[currentKid];
            var note = quickNoteInput.value.trim() || 'å¿«é€ŸåŠ é»';
            playCoinSound(); showCoinAnimation();
            kid.totalPoints += 1;
            var todayIdx = getTodayColumnIndex(); 
            var weekData = getWeekData(kid, currentViewWeekKey);
            weekData.summary[todayIdx] = (weekData.summary[todayIdx] || 0) + 1;
            addHistory(kid, note, 1);
            quickNoteInput.value = '';
            saveData(); renderAll();
        };
    }
    if(quickMinusBtn) {
        quickMinusBtn.onclick = function() {
            var kid = kidsState[currentKid];
            if(kid.totalPoints <= 0) { showToast('æ²’é»æ•¸å¯æ‰£å›‰'); return; }
            var note = quickNoteInput.value.trim() || 'å¿«é€Ÿæ‰£é»';
            playDeductSound(); showDeductAnimation();
            kid.totalPoints -= 1;
            var todayIdx = getTodayColumnIndex();
            var weekData = getWeekData(kid, currentViewWeekKey);
            weekData.summary[todayIdx] = (weekData.summary[todayIdx] || 0) - 1;
            addHistory(kid, note, -1);
            quickNoteInput.value = '';
            saveData(); renderAll();
        };
    }
    if(redeemConfirmBtn) {
        redeemConfirmBtn.onclick = function() {
            var kid = kidsState[currentKid];
            var name = redeemNameInput.value.trim();
            var pts = parseInt(redeemPointsInput.value, 10);
            var note = redeemNoteInput.value.trim();
            if(!name) { showToast('è«‹è¼¸å…¥å…Œæ›åç¨±'); return; }
            if(isNaN(pts) || pts <= 0) { showToast('è«‹è¼¸å…¥æœ‰æ•ˆé»æ•¸'); return; }
            if(kid.totalPoints < pts) { showToast('é»æ•¸ä¸è¶³ï¼'); return; }
            if(confirm('ç¢ºå®šè¦å…Œæ›ã€Œ'+name+'ã€ä¸¦æ‰£é™¤ '+pts+' é»å—ï¼Ÿ')) {
                kid.totalPoints -= pts;
                playDeductSound(); showDeductAnimation(); 
                var desc = 'å…Œæ›ï¼š' + name + (note ? (' ('+note+')') : '');
                addHistory(kid, desc, -pts);
                redeemNameInput.value = ''; redeemPointsInput.value = ''; redeemNoteInput.value = '';
                saveData(); renderAll(); showToast('å…Œæ›æˆåŠŸï¼');
            }
        };
    }
    
    function openEditKidModal(key) {
      var kid = kidsState[key];
      if (!kid) return;
      editKidKeyInput.value = key;
      editKidNameInput.value = kid.displayName;
      editKidPointsInput.value = kid.totalPoints;
      var radios = document.getElementsByName('edit-kid-theme');
      for(var i=0; i<radios.length; i++) { if (radios[i].value === kid.theme) radios[i].checked = true; }
      editKidModal.classList.add('open');
    }
    function closeEditKidModal() { editKidModal.classList.remove('open'); }
    function saveKidEdit() {
      var key = editKidKeyInput.value;
      var kid = kidsState[key];
      if (!kid) return;
      var newName = editKidNameInput.value.trim();
      var newPoints = parseInt(editKidPointsInput.value, 10);
      if (!newName || isNaN(newPoints) || newPoints < 0) return;
      var newTheme = 'boy';
      var radios = document.getElementsByName('edit-kid-theme');
      for(var i=0; i<radios.length; i++) { if (radios[i].checked) newTheme = radios[i].value; }
      kid.displayName = newName; kid.totalPoints = newPoints; kid.theme = newTheme;
      saveData(); renderAll(); closeEditKidModal(); showToast('å„²å­˜æˆåŠŸ');
    }
    if (btnCancelEdit) btnCancelEdit.addEventListener('click', closeEditKidModal);
    if (btnSaveEdit) btnSaveEdit.addEventListener('click', saveKidEdit);
    
    if(switchBtn) { switchBtn.addEventListener('click', function() { currentKid = (currentKid === 'leo') ? 'natasha' : 'leo'; renderAll(); }); }

    // Init
    loadData(); renderAll();
  </script>
</body>
</html>
